"use strict";(()=>{var Be=Object.defineProperty;var Re=(t,e)=>{for(var s in e)Be(t,s,{get:e[s],enumerable:!0})};var c=(t,e)=>{if(!t)throw new Error(e??"Failed assertion.")},re=t=>{throw new Error(t??"Reached unimplemented code.")},p=t=>{throw new Error(t??"Reached unreachable code.")};var W={};Re(W,{base64:()=>ce,hex:()=>ue,json:()=>L,toml:()=>me,utf8:()=>K,yaml:()=>ye});var G={bundle:async t=>{try{return await syscall("artifact_bundle",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},get:async t=>{try{return await syscall("artifact_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},I={bytes:async t=>{try{return await syscall("blob_bytes",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},get:async t=>{try{return await syscall("blob_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},new:async t=>{try{return await syscall("blob_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},text:async t=>{try{return await syscall("blob_text",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},z={bytes:async t=>{try{return await syscall("block_bytes",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},children:async t=>{try{return syscall("block_children",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},data:async t=>{try{return await syscall("block_data",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},new:async t=>{try{return syscall("block_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var se={new:async t=>{try{return await syscall("directory_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},R;(r=>(r.base64={decode:o=>{try{return syscall("encoding_base64_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_base64_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.hex={decode:o=>{try{return syscall("encoding_hex_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_hex_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.json={decode:o=>{try{return syscall("encoding_json_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_json_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.toml={decode:o=>{try{return syscall("encoding_toml_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_toml_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.utf8={decode:o=>{try{return syscall("encoding_utf8_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_utf8_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.yaml={decode:o=>{try{return syscall("encoding_yaml_decode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:o=>{try{return syscall("encoding_yaml_encode",o)}catch(i){throw new Error("The syscall failed.",{cause:i})}}}))(R||={});var ae={new:async t=>{try{return await syscall("file_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},ne=t=>{try{return syscall("log",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},N={get:async t=>{try{return await syscall("operation_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},evaluation:async t=>{try{return await syscall("operation_evaluate",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},oe={new:async t=>{try{return await syscall("resource_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},Y={new:async t=>{try{return await syscall("target_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},le={new:async t=>{try{return await syscall("task_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},ie={new:async t=>{try{return await syscall("symlink_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var ce;(s=>(s.decode=a=>R.base64.decode(a),s.encode=a=>R.base64.encode(a)))(ce||={});var ue;(s=>(s.decode=a=>R.hex.decode(a),s.encode=a=>R.hex.encode(a)))(ue||={});var L;(s=>(s.decode=a=>R.json.decode(a),s.encode=a=>R.json.encode(a)))(L||={});var me;(s=>(s.decode=a=>R.toml.decode(a),s.encode=a=>R.toml.encode(a)))(me||={});var K;(s=>(s.decode=a=>R.utf8.decode(a),s.encode=a=>R.utf8.encode(a)))(K||={});var ye;(s=>(s.decode=a=>R.yaml.decode(a),s.encode=a=>R.yaml.encode(a)))(ye||={});var _=t=>t.flat(1/0);var q=async(...t)=>await x.new(...t),x=class t{#e;#t;#r;#s;static async new(...e){let{contents:s,executable:a,references:n}=_(await Promise.all(e.map(async function r(o){let i=await k(o);return h.Arg.is(i)?{contents:i}:t.is(i)?{contents:i.#t,executable:i.#r,references:await i.references()}:i instanceof Array?await Promise.all(i.map(r)):i instanceof Object?{contents:i.contents,executable:i.executable,references:i.references}:p()}))).reduce((r,{contents:o,executable:i,references:u})=>(r.contents.push(o),r.executable=i!==void 0?i:r.executable,r.references.push(...u??[]),r),{contents:[],executable:!1,references:[]}),l=await H(...s);return t.fromSyscall(await ae.new({contents:l.toSyscall(),executable:a,references:n.map(r=>y.toSyscall(r))}))}constructor(e){this.#e=e.block,this.#t=e.contents,this.#r=e.executable,this.#s=e.references}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=this.#t.toSyscall(),a=this.#r,n=this.#s.map(l=>l.toSyscall());return{block:e,contents:s,executable:a,references:n}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=m.fromSyscall(e.contents),n=e.executable,l=e.references.map(r=>m.fromSyscall(r));return new t({block:s,contents:a,executable:n,references:l})}block(){return this.#e}async contents(){return await h.get(this.#t)}executable(){return this.#r}async references(){return await Promise.all(this.#s.map(y.get))}async bytes(){return await(await this.contents()).bytes()}async text(){return await(await this.contents()).text()}};var U=(...t)=>d.new(...t),E=(...t)=>b.new(...t),d=class t{#e;#t;static new(...e){return e.reduce(function s(a,n){if(typeof n=="string")for(let l of n.split("/"))l===""||l==="."||(l===".."?a=a.parent():a.#t.push(l));else if(n instanceof t){for(let l=0;l<n.#e;l++)a.parent();a.#t.join(n.#t)}else if(n instanceof b)a.#t.join(n);else if(n instanceof Array)n.forEach(l=>s(a,l));else return p();return a},new t)}constructor(e){this.#e=e?.parents??0,this.#t=e?.subpath??new b}static is(e){return e instanceof t}toSyscall(){return this.toString()}static fromSyscall(e){return t.new(e)}isEmpty(){return this.#e==0&&this.#t.isEmpty()}parents(){return this.#e}subpath(){return this.#t}parent(){return this.#t.isEmpty()?this.#e+=1:this.#t.pop(),this}join(e){e=t.new(e);for(let s=0;s<e.#e;s++)this.parent();return this.#t.join(e.#t),this}extension(){return this.#t.extension()}toSubpath(){if(this.#e>0)throw new Error("Cannot convert to subpath.");return this.#t}toString(){let e="";for(let s=0;s<this.#e;s++)e+="../";return e+=this.#t.toString(),e}};(e=>{let t;(l=>(l.is=r=>r===void 0||typeof r=="string"||r instanceof b||r instanceof e||r instanceof Array&&r.every(e.Arg.is),l.expect=r=>(c((0,l.is)(r)),r),l.assert=r=>{c((0,l.is)(r))}))(t=e.Arg||={})})(d||={});var b=class t{#e;static new(...e){return d.new(...e).toSubpath()}constructor(e){this.#e=e??[]}static is(e){return e instanceof t}toSyscall(){return this.toString()}static fromSyscall(e){return E(e)}components(){return[...this.#e]}isEmpty(){return this.#e.length==0}join(e){return this.#e.push(...e.#e),this}push(e){this.#e.push(e)}pop(){this.#e.pop()}extension(){return this.#e.at(-1)?.split(".").at(-1)}toRelpath(){return d.new(this)}toString(){return this.#e.join("/")}};var J=t=>S.new(t),S=class t{#e;static new(e){return new t(e)}constructor(e){this.#e=e}static is(e){return e instanceof t}toSyscall(){return{name:this.#e}}static fromSyscall(e){let s=e.name;return new t(s)}name(){return this.#e}};var D;(s=>s.get=()=>(c(s.value),s.value))(D||={});var M=async(t,...e)=>{let s=[];for(let a=0;a<t.length-1;a++){let n=t[a];s.push(n);let l=e[a];s.push(l)}return s.push(t[t.length-1]),await F(...s)},F=(...t)=>f.new(...t),f=class t{#e;static async new(...e){let s=_(await Promise.all(e.map(async function a(n){return n=await k(n),t.Component.is(n)?n:n instanceof d||n instanceof b?n.toString():n instanceof t?n.components():n instanceof Array?await Promise.all(n.map(a)):p()}))).reduce((a,n)=>(a.push(n),a),[]);return s=s.reduce((a,n)=>{let l=a.at(-1);return n===""||(typeof l=="string"&&typeof n=="string"?a.splice(-1,1,l+n):a.push(n)),a},[]),new t(s)}constructor(e){this.#e=e}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}static async join(e,...s){let a=await F(e),n=await Promise.all(s.map(r=>F(r)));n=n.filter(r=>r.components().length>0);let l=[];for(let r=0;r<n.length;r++){r>0&&l.push(a);let o=n[r];c(o),l.push(o)}return F(...l)}toSyscall(){return{components:this.#e.map(s=>t.Component.toSyscall(s))}}static fromSyscall(e){let s=e.components.map(a=>t.Component.fromSyscall(a));return new t(s)}components(){return[...this.#e]}};(e=>{let t;(l=>(l.is=r=>typeof r=="string"||y.is(r)||r instanceof S,l.toSyscall=r=>typeof r=="string"?{kind:"string",value:r}:y.is(r)?{kind:"artifact",value:y.toSyscall(r)}:r instanceof S?{kind:"placeholder",value:r.toSyscall()}:p(),l.fromSyscall=r=>{switch(r.kind){case"string":return r.value;case"artifact":return y.fromSyscall(r.value);case"placeholder":return S.fromSyscall(r.value);default:return p()}}))(t=e.Component||={})})(f||={});var Z=async(...t)=>await A.new(...t),A=class t{#e;#t;static async new(...e){let{artifact:s,path:a}=_(await Promise.all(e.map(async function l(r){let o=await k(r);if(typeof o=="string")return{path:U(o)};if(d.is(o))return{path:U(o)};if(b.is(o))return{path:o.toRelpath()};if(y.is(o))return{artifact:o};if(o instanceof f){c(o.components().length<=2);let[i,u]=o.components();if(typeof i=="string"&&u===void 0)return{path:U(i)};if(y.is(i)&&u===void 0)return{artifact:i};if(y.is(i)&&typeof u=="string")return c(u.startsWith("/")),{artifact:i,path:U(u.slice(1))};throw new Error("Invalid template.")}else return o instanceof t?{artifact:o.artifact(),path:o.path()}:o instanceof Array?await Promise.all(o.map(l)):typeof o=="object"?{artifact:o.artifact,path:U(o.path)}:p()}))).reduce((l,{artifact:r,path:o})=>(r!==void 0?(l.artifact=r,l.path=o??U()):l.path=l.path.join(o),l),{artifact:void 0,path:U()}),n;if(s!==void 0&&!a.isEmpty())n=await M`${s}/${a}`;else if(s!==void 0)n=await M`${s}`;else if(!a.isEmpty())n=await M`${a}`;else throw new Error("Invalid symlink.");return t.fromSyscall(await ie.new({target:n.toSyscall()}))}constructor(e){this.#e=e.block,this.#t=e.target}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=this.#t.toSyscall();return{block:e,target:s}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=f.fromSyscall(e.target);return new t({block:s,target:a})}block(){return this.#e}target(){return this.#t}artifact(){let e=this.#t.components().at(0);if(y.is(e))return e}path(){let[e,s]=this.#t.components();if(typeof e=="string"&&s===void 0)return U(e);if(y.is(e)&&s===void 0)return U();if(y.is(e)&&typeof s=="string")return U(s.slice(1));throw new Error("Invalid template.")}async resolve(e){e=e?await Z(e):void 0;let s=e?.artifact();s instanceof t&&(s=await s.resolve());let a=e?.path(),n=this.artifact();n instanceof t&&(n=await n.resolve());let l=this.path();if(n!==void 0&&l.isEmpty())return n;if(n===void 0&&!l.isEmpty()){if(!(s instanceof g))throw new Error("Expected a directory.");return await s.tryGet((a??U()).parent().join(l).toSubpath())}else if(n!==void 0&&!l.isEmpty()){if(!(n instanceof g))throw new Error("Expected a directory.");return await n.tryGet(l.toSubpath())}else throw new Error("Invalid symlink.")}};var pe=async t=>await P.new(t),fe=async t=>await(await P.new(t)).run(),de=J("output"),P=class t{#e;#t;#r;#s;#a;#n;#o;#l;static async new(e){let s=await k(e),a=s.system,n=await F(s.executable),l=Object.fromEntries(await Promise.all(Object.entries(s.env??{}).map(async([T,C])=>[T,await F(C)]))),r=Object.fromEntries(Object.entries(l).map(([T,C])=>[T,C.toSyscall()])),o=await Promise.all((s.args??[]).map(async T=>(await F(T)).toSyscall())),i=s.checksum??void 0,u=s.unsafe??!1,v=s.network??!1;return t.fromSyscall(await le.new({system:a,executable:n.toSyscall(),env:r,args:o,checksum:i,unsafe:u,network:v}))}constructor(e){this.#e=e.block,this.#t=e.system,this.#r=e.executable,this.#s=e.env,this.#a=e.args,this.#n=e.checksum,this.#o=e.unsafe,this.#l=e.network}toSyscall(){let e=this.#e.toSyscall(),s=this.#t,a=this.#r.toSyscall(),n=Object.fromEntries(Object.entries(this.#s).map(([u,v])=>[u,v.toSyscall()])),l=this.#a.map(u=>u.toSyscall()),r=this.#n,o=this.#o,i=this.#l;return{block:e,system:s,executable:a,env:n,args:l,checksum:r,unsafe:o,network:i}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=e.system,n=f.fromSyscall(e.executable),l=Object.fromEntries(Object.entries(e.env).map(([v,T])=>[v,f.fromSyscall(T)])),r=e.args.map(v=>f.fromSyscall(v)),o=e.checksum,i=e.unsafe,u=e.network;return new t({block:s,system:a,executable:n,env:l,args:r,checksum:o,unsafe:i,network:u})}block(){return this.#e}async run(){let e=await N.evaluation(V.toSyscall(this));return w.fromSyscall(e)}};var w;(l=>(l.is=r=>r===void 0||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Uint8Array||r instanceof d||r instanceof b||r instanceof h||r instanceof m||r instanceof g||r instanceof x||r instanceof A||r instanceof S||r instanceof f||r instanceof j||r instanceof B||r instanceof P||r instanceof Array||typeof r=="object",l.expect=r=>(c((0,l.is)(r)),r),l.assert=r=>{c((0,l.is)(r))},l.toSyscall=r=>r===void 0?{kind:"null"}:typeof r=="boolean"?{kind:"bool",value:r}:typeof r=="number"?{kind:"number",value:r}:typeof r=="string"?{kind:"string",value:r}:r instanceof Uint8Array?{kind:"bytes",value:r}:r instanceof d?{kind:"relpath",value:r.toSyscall()}:r instanceof b?{kind:"subpath",value:r.toSyscall()}:r instanceof m?{kind:"block",value:r.toSyscall()}:r instanceof h?{kind:"blob",value:r.toSyscall()}:y.is(r)?{kind:"artifact",value:y.toSyscall(r)}:r instanceof S?{kind:"placeholder",value:r.toSyscall()}:r instanceof f?{kind:"template",value:r.toSyscall()}:V.is(r)?{kind:"operation",value:V.toSyscall(r)}:r instanceof Array?{kind:"array",value:r.map(i=>l.toSyscall(i))}:typeof r=="object"?{kind:"object",value:Object.fromEntries(Object.entries(r).map(([i,u])=>[i,l.toSyscall(u)]))}:p(),l.fromSyscall=r=>{switch(r.kind){case"null":return;case"bool":return r.value;case"number":return r.value;case"string":return r.value;case"bytes":return r.value;case"relpath":return d.fromSyscall(r.value);case"subpath":return b.fromSyscall(r.value);case"block":return m.fromSyscall(r.value);case"blob":return h.fromSyscall(r.value);case"artifact":return y.fromSyscall(r.value);case"placeholder":return S.fromSyscall(r.value);case"template":return f.fromSyscall(r.value);case"operation":return V.fromSyscall(r.value);case"array":return r.value.map(o=>l.fromSyscall(o));case"object":return Object.fromEntries(Object.entries(r.value).map(([o,i])=>[o,l.fromSyscall(i)]));default:return p()}}))(w||={});var Q={},he=async t=>{c(t.module.kind==="normal");let e=B.fromSyscall(await Y.new({package:t.module.value.package,modulePath:t.module.value.modulePath,name:t.name,env:{},args:[]}));e.f=t.f;let s=L.encode({module:t.module,name:t.name});return c(Q[s]===void 0),Q[s]=e,e},ke=async(t,e,s)=>{D.value=Object.fromEntries(Object.entries(e).map(([r,o])=>[r,w.fromSyscall(o)]));let a=s.map(r=>w.fromSyscall(r)),n=await t(...a);return w.toSyscall(n)},B=class t extends globalThis.Function{f;block;package;modulePath;name;env;args;static async new(e){let s=Object.fromEntries(Object.entries(e.env??{}).map(([l,r])=>[l,w.toSyscall(r)])),a=(e.args??[]).map(l=>w.toSyscall(l)),n=t.fromSyscall(await Y.new({package:e.target.package.toSyscall(),modulePath:e.target.modulePath.toSyscall(),name:e.target.name,env:s,args:a}));return n.f=e.target.f,n}constructor(e){return super(),this.f=e.f,this.block=e.block,this.package=e.package,this.modulePath=E(e.modulePath),this.name=e.name,this.env=e.env,this.args=e.args,new Proxy(this,{apply:async(s,a,n)=>{let l=await t.new({target:s,args:await Promise.all(n.map(k)),env:D.value}),r=await N.evaluation(V.toSyscall(l));return w.fromSyscall(r)}})}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.block.toSyscall(),s=this.package.toSyscall(),a=this.modulePath.toString(),n=this.name,l=this.env?Object.fromEntries(Object.entries(this.env).map(([o,i])=>[o,w.toSyscall(i)])):void 0,r=this.args?this.args.map(o=>w.toSyscall(o)):void 0;return{block:e,package:s,modulePath:a,name:n,env:l,args:r}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=m.fromSyscall(e.package),n=e.modulePath,l=e.name,r=e.env!==void 0?Object.fromEntries(Object.entries(e.env).map(([i,u])=>[i,w.fromSyscall(u)])):void 0,o=e.args!==void 0?e.args.map(i=>w.fromSyscall(i)):void 0;return new t({block:s,package:a,modulePath:n,name:l,env:r,args:o})}};var V;(a=>(a.is=n=>n instanceof j||n instanceof B||n instanceof P,a.toSyscall=n=>n instanceof j?{kind:"resource",value:n.toSyscall()}:n instanceof B?{kind:"target",value:n.toSyscall()}:n instanceof P?{kind:"task",value:n.toSyscall()}:p(),a.fromSyscall=n=>{switch(n.kind){case"resource":return j.fromSyscall(n.value);case"target":return B.fromSyscall(n.value);case"task":return P.fromSyscall(n.value);default:return p()}}))(V||={});var be=async t=>await j.new(t),ge=async t=>await(await j.new(t)).download(),j=class t{#e;#t;#r;#s;#a;static async new(e){return t.fromSyscall(await oe.new({url:e.url,unpack:e.unpack??void 0,checksum:e.checksum??void 0,unsafe:e.unsafe??!1}))}constructor(e){this.#e=e.block,this.#t=e.url,this.#r=e.unpack??void 0,this.#s=e.checksum??void 0,this.#a=e.unsafe??!1}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}block(){return this.#e}toSyscall(){return{block:this.#e.toSyscall(),url:this.#t,unpack:this.#r,checksum:this.#s,unsafe:this.#a}}static fromSyscall(e){return new t({block:m.fromSyscall(e.block),url:e.url,unpack:e.unpack,checksum:e.checksum,unsafe:e.unsafe})}async download(){let e=await N.evaluation(V.toSyscall(this));return w.fromSyscall(e)}};var k=async t=>{if(t=await t,t===void 0||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Uint8Array||t instanceof d||t instanceof b||t instanceof h||t instanceof g||t instanceof x||t instanceof A||t instanceof S||t instanceof f||t instanceof j||t instanceof B||t instanceof P)return t;if(t instanceof Array)return await Promise.all(t.map(e=>k(e)));if(typeof t=="object")return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,s])=>[e,await k(s)])));throw new Error("Invalid value to resolve.")};var Ae=async(...t)=>await m.new(...t),m=class t{#e;static withId(e){return new t({id:e})}static async new(...e){let{children:s,data:a}=_(await Promise.all(e.map(async function o(i){let u=await k(i);if(u===void 0)return{};if(typeof u=="string")return{data:[K.encode(u)]};if(u instanceof Uint8Array)return{data:[u]};if(u instanceof t)return{children:await u.children(),data:[await u.bytes()]};if(u instanceof Array)return await Promise.all(u.map(o));if(typeof u=="object"){let v=await Promise.all((u.children??[]).map(C=>t.new(C))),T=typeof u.data=="string"?[K.encode(u.data)]:u.data instanceof Uint8Array?[u.data]:[];return{children:v,data:T}}else return p()}))).reduce((o,{children:i,data:u})=>(i!==void 0&&o.children.push(...i),u!==void 0&&o.data.push(...u),o),{children:[],data:[]}),n=a.reduce((o,i)=>o+i.length,0),l=new Uint8Array(n),r=0;for(let o of a)l.set(o,r),r+=o.length;return t.fromSyscall(await z.new({data:l,children:s.map(o=>o.toSyscall())}))}constructor(e){this.#e=e.id}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){return{id:this.#e}}static fromSyscall(e){let s=e.id;return new t({id:s})}id(){return this.#e}async bytes(){return await z.bytes(this.toSyscall())}async children(){return(await z.children(this.toSyscall())).map(e=>t.fromSyscall(e))}async data(){return await z.data(this.toSyscall())}};(e=>{let t;(l=>(l.is=r=>r===void 0||typeof r=="string"||r instanceof Uint8Array||r instanceof e||r instanceof Array&&r.every(l.is),l.expect=r=>(c((0,l.is)(r)),r),l.assert=r=>{c((0,l.is)(r))}))(t=e.Arg||={})})(m||={});var H=async(...t)=>await h.new(...t),h=class t{#e;#t;static async get(e){return t.fromSyscall(await I.get(e.toSyscall()))}static async new(...e){let s=_(await Promise.all(e.map(async function a(n){let l=await k(n);return m.Arg.is(l)?await Ae(l):l instanceof t?l.block():l instanceof Array?await Promise.all(l.map(a)):p()}))).reduce((a,n)=>(a.push(n),a),[]);return t.fromSyscall(await I.new({children:s.map(a=>a.toSyscall())}))}constructor(e){this.#e=e.block,this.#t=e.kind}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){return{block:this.#e.toSyscall(),kind:this.#t}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=e.kind;return new t({block:s,kind:a})}block(){return this.#e}async bytes(){return await I.bytes(this.toSyscall())}async text(){return await I.text(this.toSyscall())}};(e=>{let t;(l=>(l.is=r=>m.Arg.is(r)||r instanceof e||r instanceof Array&&r.every(l.is),l.expect=r=>(c((0,l.is)(r)),r),l.assert=r=>{c((0,l.is)(r))}))(t=e.Arg||={})})(h||={});var we=async(...t)=>await g.new(...t),g=class t{#e;#t;static async new(...e){let s=await(await Promise.all(e.map(k))).reduce(async function a(n,l){let r=await n;if(l!==void 0)if(l instanceof t)for(let[o,i]of Object.entries(await l.entries())){let u=r[o];u instanceof t&&i instanceof t&&(i=await t.new(u,i)),r[o]=i}else if(l instanceof Array)for(let o of l)r=await a(Promise.resolve(r),o);else if(typeof l=="object")for(let[o,i]of Object.entries(l)){let[u,...v]=E(o).components();if(u===void 0)throw new Error("The path must have at least one component.");let T=u,C=r[T];if(C instanceof t||(C=void 0),v.length>0){let $=E(v).toString(),Pe=await t.new(C,{[$]:i});r[T]=Pe}else if(i===void 0)delete r[T];else if(h.Arg.is(i)){let $=await q(i);r[T]=$}else if(x.is(i)||A.is(i))r[T]=i;else{let $=await t.new(C,i);r[T]=$}}else return p();return r},Promise.resolve({}));return t.fromSyscall(await se.new({entries:Object.fromEntries(Object.entries(s).map(([a,n])=>[a,y.toSyscall(n)]))}))}constructor(e){this.#e=e.block,this.#t=e.entries}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=Object.fromEntries(Object.entries(this.#t).map(([a,n])=>[a,n.toSyscall()]));return{block:e,entries:s}}static fromSyscall(e){let s=m.fromSyscall(e.block),a=Object.fromEntries(Object.entries(e.entries).map(([n,l])=>[n,m.fromSyscall(l)]));return new t({block:s,entries:a})}block(){return this.#e}async get(e){let s=await this.tryGet(e);return c(s,`Failed to get the directory entry "${e}".`),s}async tryGet(e){let s=this,a=E();e=E(e);for(let n of e.components()){if(!(s instanceof t))return;a.push(n);let l=s.#t[n];if(l===void 0)return;let r=await y.get(l);if(r instanceof A){let o=await r.resolve({artifact:this,path:a});if(o===void 0)return;s=o}else s=r}return s}async entries(){let e={};for await(let[s,a]of this)e[s]=a;return e}async bundle(){let e=y.fromSyscall(await G.bundle(y.toSyscall(this)));return c(t.is(e)),e}async*walk(){for await(let[e,s]of this)if(yield[E(e),s],t.is(s))for await(let[a,n]of s.walk())yield[E(e).join(a),n]}*[Symbol.iterator](){for(let[e,s]of Object.entries(this.#t))yield[e,s]}async*[Symbol.asyncIterator](){for(let[e,s]of this)yield[e,await y.get(s)]}};var y;(r=>(r.is=o=>o instanceof g||o instanceof x||o instanceof A,r.expect=o=>(c((0,r.is)(o)),o),r.assert=o=>{c((0,r.is)(o))},r.get=async o=>r.fromSyscall(await G.get(o.toSyscall())),r.toSyscall=o=>o instanceof g?{kind:"directory",value:o.toSyscall()}:o instanceof x?{kind:"file",value:o.toSyscall()}:o instanceof A?{kind:"symlink",value:o.toSyscall()}:p(),r.fromSyscall=o=>{switch(o.kind){case"directory":return g.fromSyscall(o.value);case"file":return x.fromSyscall(o.value);case"symlink":return A.fromSyscall(o.value);default:return p()}}))(y||={});var xe=(t,e)=>({callSites:e.map(a=>({typeName:a.getTypeName(),functionName:a.getFunctionName(),methodName:a.getMethodName(),fileName:a.getFileName(),lineNumber:a.getLineNumber(),columnNumber:a.getColumnNumber(),isEval:a.isEval(),isNative:a.isNative(),isConstructor:a.isConstructor(),isAsync:a.isAsync(),isPromiseAll:a.isPromiseAll(),promiseIndex:a.getPromiseIndex()}))});var Se=async t=>{c(t.module.kind==="normal");let e=await y.get(m.fromSyscall(t.module.value.package));g.assert(e);let s=E(t.module.value.modulePath).toRelpath().parent().join(t.path).toSubpath();return e.get(s)};var ee=(...t)=>{let e=t.map(s=>Ue(s)).join(" ");ne(e)},Ue=t=>X(t,new WeakSet),X=(t,e)=>{switch(typeof t){case"string":return`"${t}"`;case"number":return t.toString();case"boolean":return t?"true":"false";case"undefined":return"undefined";case"object":return t===null?"null":Ee(t,e);case"function":return`(function "${t.name??"(anonymous)"}")`;case"symbol":return"(symbol)";case"bigint":return t.toString()}},Ee=(t,e)=>{if(e.has(t))return"(circular)";if(e.add(t),t instanceof Array)return`[${t.map(s=>X(s,e)).join(", ")}]`;if(t instanceof Error)return t.stack??"";if(t instanceof Promise)return"(promise)";if(t instanceof d)return`(tg.relpath ${t.toString()})`;if(t instanceof b)return`(tg.subpath ${t.toString()})`;if(t instanceof h)return`(tg.blob ${t.block().id()})`;if(t instanceof m)return`(tg.block ${t.id()})`;if(t instanceof g)return`(tg.directory ${t.block().id()})`;if(t instanceof x)return`(tg.file ${t.block().id()})`;if(t instanceof A)return`(tg.symlink ${t.block().id()})`;if(t instanceof S)return`(tg.placeholder "${t.name()}")`;if(t instanceof f)return`(tg.template "${t.components().map(a=>typeof a=="string"?a:`\${${X(a,e)}}`).join("")}")`;if(t instanceof j)return`(tg.resource "${t.block().id()}")`;if(t instanceof B)return`(tg.target "${t.block.id()}")`;if(t instanceof P)return`(tg.task "${t.block().id()}")`;{let s="";t.constructor!==void 0&&t.constructor.name!=="Object"&&(s=`${t.constructor.name} `);let a=Object.entries(t).map(([n,l])=>`${n}: ${X(l,e)}`);return`${s}{ ${a.join(", ")} }`}};var Te=t=>{if(typeof t=="string")return t;{let{arch:e,os:s}=t;return`${e}_${s}`}},te;(a=>(a.is=n=>n==="amd64_linux"||n==="arm64_linux"||n==="amd64_macos"||n==="arm64_macos",a.arch=n=>{switch(n){case"amd64_linux":case"amd64_macos":return"amd64";case"arm64_linux":case"arm64_macos":return"arm64";default:throw new Error("Invalid system.")}},a.os=n=>{switch(n){case"amd64_linux":case"arm64_linux":return"linux";case"amd64_macos":case"arm64_macos":return"macos";default:throw new Error("Invalid system.")}}))(te||={});Object.defineProperties(Error,{prepareStackTrace:{value:xe}});var je={log:ee};Object.defineProperties(globalThis,{console:{value:je}});var ve={Artifact:y,Blob:h,Block:m,Directory:g,File:x,Placeholder:S,Relpath:d,Subpath:b,Symlink:A,System:te,Target:B,Task:P,Template:f,Value:w,assert:c,blob:H,directory:we,download:ge,encoding:W,entrypoint:ke,env:D,file:q,include:Se,log:ee,output:de,placeholder:J,relpath:U,resolve:k,resource:be,run:fe,subpath:E,symlink:Z,system:Te,target:he,targets:Q,task:pe,template:F,unimplemented:re,unreachable:p};Object.defineProperties(globalThis,{tg:{value:ve},t:{value:M}});})();
//# sourceMappingURL=global.js.map
