"use strict";(()=>{var y=(t,e)=>{if(!t)throw e=e??"Failed assertion.",new Error(e)};var S=async t=>await syscall("add_blob",t),N=async t=>await syscall("get_blob",t);var G=t=>t instanceof Uint8Array||typeof t=="string"||t instanceof c,j=async(t,e)=>{t=await t;let r,a;return t instanceof Uint8Array?r=await S(t):typeof t=="string"?r=await S(syscall("encode_utf8",t)):(r=t.blobHash(),a=t.executable()),a=e?.executable??a,new c(r,{executable:a})},D=t=>t instanceof c,c=class{#e;#t;constructor(e,r){this.#e=e,this.#t=r?.executable??!1}static async fromHash(e){let r=await u(e);return y(D(r)),r}async serialize(){let e=this.#e,r=this.#t;return{blobHash:e,executable:r}}static async deserialize(e){let r=e.blobHash,a=e.executable;return new c(r,{executable:a})}blobHash(){return this.#e}async getBytes(){return await N(this.#e)}async getString(){let e=await this.getBytes();return syscall("decode_utf8",e)}executable(){return this.#t}};var h=t=>new H(t),q=t=>t instanceof H,H=class{#e;constructor(e){if(typeof e=="string"){this.#e=[];let r=e.split("/");for(let a of r)a===""||(a==="."?this.#e.push({kind:"current_dir"}):a===".."?this.#e.push({kind:"parent_dir"}):this.#e.push({kind:"normal",value:a}))}else Array.isArray(e)?this.#e=e:this.#e=e.components()}components(){return[...this.#e]}parent(){let e=this.components();return e.length===0?void 0:(e.pop(),h(e))}push(e){this.#e.push(e)}join(e){return h([...this.components(),...h(e).components()])}normalize(){let e=[];for(let r of this.components())switch(r.kind){case"current_dir":break;case"parent_dir":{e.every(a=>a.kind==="parent_dir")?e.push(r):e.pop();break}case"normal":{e.push(r);break}}return h(e)}toString(){let e=[];for(let r of this.components())switch(r.kind){case"current_dir":{e.push(".");break}case"parent_dir":{e.push("..");break}case"normal":{e.push(r.value);break}}return e.join("/")}};var F=async(...t)=>{let e=new Map;for(let r of t)if(r=await r,!x(r))if(r instanceof o)for(let[a,i]of r)e.set(a,i);else for(let[a,i]of Object.entries(r)){let[n,...d]=h(a).normalize().components();if(n.kind!=="normal")throw new Error("Invalid path component.");let l=n.value;if(d.length>0){let C=h(d).toString(),K=e.get(l),_;K!==void 0&&(_=await u(K),_ instanceof o||(_=void 0));let ie=await F(_,{[C]:i});e.set(l,await w(ie))}else i=await i,x(i)?e.delete(l):G(i)?e.set(l,await w(await j(i))):O(i)?e.set(l,await w(i)):e.set(l,await w(await F(i)))}return new o(e)},v=t=>t instanceof o,o=class{#e;constructor(e){this.#e=e}static async fromHash(e){let r=await u(e);return y(v(r)),r}async serialize(){return{entries:Object.fromEntries(Array.from(this.#e.entries()))}}static async deserialize(e){let r=new Map(Object.entries(e.entries));return new o(r)}async tryGet(e){let[r,...a]=h(e).normalize().components();if(r.kind!=="normal")throw new Error(`Invalid path "${e}".`);let i=this.#e.get(r.value);if(!i)return null;let n=await u(i);return a.length>0?(y(v(n)),await n.tryGet(a)):n}async get(e){let r=await this.tryGet(e);if(r===null)throw new Error(`Failed to get directory entry "${e}".`);return r}async getEntries(){let e={};for await(let[r,a]of this)e[r]=await a;return e}*[Symbol.iterator](){for(let[e,r]of this.#e)yield[e,r]}async*[Symbol.asyncIterator](){for(let e of this.#e.keys())yield[e,await this.get(e)]}};var J=async t=>{let e=await w(await t.artifact),r=x(t.path)?t.path:h(t.path);return new p({artifactHash:e,path:r})},E=t=>t instanceof p,p=class{#e;#t;constructor(e){this.#e=e.artifactHash,this.#t=e.path}static async fromHash(e){let r=await u(e);return y(E(r)),r}async serialize(){let e=this.#e,r=this.#t?.toString();return{artifactHash:e,path:r}}static async deserialize(e){let r=e.artifactHash,a=x(e.path)?e.path:h(e.path);return new p({artifactHash:r,path:a})}async getArtifact(){return await u(this.#e)}path(){return this.#t}};var Q=t=>new f(t),I=t=>t instanceof f,f=class{#e;constructor(e){this.#e=e}static async fromHash(e){let r=await u(e);return y(I(r)),r}async serialize(){return{target:this.#e}}static async deserialize(e){return new f(e.target)}target(){return this.#e}};var O=t=>t instanceof o||t instanceof c||t instanceof f||t instanceof p,w=async t=>await syscall("add_artifact",await ne(t)),u=async t=>await se(await syscall("get_artifact",t)),ne=async t=>{if(t instanceof o)return{kind:"directory",value:await t.serialize()};if(t instanceof c)return{kind:"file",value:await t.serialize()};if(t instanceof f)return{kind:"symlink",value:await t.serialize()};if(t instanceof p)return{kind:"reference",value:await t.serialize()};throw new Error("Unknown artifact type")},se=async t=>{switch(t.kind){case"directory":return await o.deserialize(t.value);case"file":return await c.deserialize(t.value);case"symlink":return await f.deserialize(t.value);case"reference":return await p.deserialize(t.value)}};var M=t=>new m(t),W=t=>t instanceof m,m=class{name;constructor(e){this.name=e}async serialize(){return{name:this.name}}static async deserialize(e){let r=e.name;return new m(r)}};var g=async t=>{if(t=await t,t==null||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof o||t instanceof c||t instanceof f||t instanceof p||t instanceof m||t instanceof s)return t;if(Array.isArray(t))return await Promise.all(t.map(e=>g(e)));if(typeof t=="object")return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,r])=>[e,await g(r)])));if(typeof t=="function")return await g(t());throw new Error("Invalid value to resolve.")};var X=async(t,...e)=>{let r=[];for(let a=0;a<t.length-1;a++){let i=t[a],n=e[a];r.push(i),r.push(n)}return r.push(t[t.length-1]),await b(r)},b=async t=>{let e=await g(t),r=[],a=i=>{Array.isArray(i)?i.forEach(a):i instanceof s?r.push(...i.components()):r.push(i)};return a(e),new s(r)},Y=t=>t instanceof s,s=class{#e;constructor(e){this.#e=e}async serialize(){return{components:await Promise.all(this.#e.map(async r=>await oe(r)))}}static async deserialize(e){return new s(await Promise.all(e.components.map(async r=>await le(r))))}components(){return[...this.#e]}render(e){return this.#e.map(e).join("")}},oe=async t=>{if(typeof t=="string")return{kind:"string",value:t};if(O(t))return{kind:"artifact",value:await w(t)};if(t instanceof m)return{kind:"placeholder",value:await t.serialize()};throw new Error("Invalid template component.")},le=async t=>{switch(t.kind){case"string":return await t.value;case"artifact":return await u(t.value);case"placeholder":return await m.deserialize(t.value)}};var x=t=>t==null;var P=async t=>{if(t==null)return{kind:"null",value:t};if(typeof t=="boolean")return{kind:"bool",value:t};if(typeof t=="number")return{kind:"number",value:t};if(typeof t=="string")return{kind:"string",value:t};if(O(t))return{kind:"artifact",value:await w(t)};if(t instanceof m)return{kind:"placeholder",value:await t.serialize()};if(t instanceof s)return{kind:"template",value:await t.serialize()};if(Array.isArray(t))return{kind:"array",value:await Promise.all(t.map(r=>P(r)))};if(typeof t=="object")return{kind:"map",value:Object.fromEntries(await Promise.all(Object.entries(t).map(async([r,a])=>[r,await P(a)])))};throw new Error("Failed to serialize the value.")},A=async t=>{switch(t.kind){case"null":return t.value;case"bool":return t.value;case"number":return t.value;case"string":return t.value;case"artifact":return await u(t.value);case"placeholder":return await m.deserialize(t.value);case"template":return await s.deserialize(t.value);case"array":return await Promise.all(t.value.map(e=>A(e)));case"map":return Object.fromEntries(await Promise.all(Object.entries(t.value).map(async([e,r])=>[e,await A(r)])))}};var B=class{async get(e){let r=syscall("get_context_value",e);return x(r)?void 0:await A(r)}async set(e,r){let a=await P(r);syscall("set_context_value",e,a)}async entries(){let e=syscall("get_context_keys");return await Promise.all(e.map(async a=>{let i=await this.get(a);return y(i),[a,i]}))}},U=new B;var Z=t=>{let e=syscall("get_current_package_instance_hash"),r=syscall("get_current_export_name");return new k({packageInstanceHash:e,name:r,implementation:t})};var k=class extends globalThis.Function{packageInstanceHash;name;implementation;constructor(e){return super(),this.packageInstanceHash=e.packageInstanceHash,this.name=e.name,this.implementation=e.implementation,new Proxy(this,{apply:(r,a,i)=>r._call(...i)})}async serialize(){let e=this.packageInstanceHash,r=this.name?.toString();return{packageInstanceHash:e,name:r}}static async deserialize(e){let r=e.packageInstanceHash,a=e.name;return new k({packageInstanceHash:r,name:a})}async _call(...e){let r=new Map(await U.entries()),a=await Promise.all(e.map(g));return await ee({function:this,context:r,args:a})}async run(...e){y(this.implementation,"This function does not have an implementation.");let r=await Promise.all(e.map(A)),a=await this.implementation(...r);return await P(a)}};var ee=async t=>{let e=t.function,r=t.context??new Map,a=t.args??[];return await new T({function:e,context:r,args:a}).run()};var T=class{#e;#t;#r;constructor(e){this.#e=e.function,this.#t=e.context,this.#r=e.args}async serialize(){let e=await this.#e.serialize(),r=Object.fromEntries(await Promise.all(Array.from(this.#t.entries()).map(async([i,n])=>[i,await P(n)]))),a=await Promise.all(this.#r.map(i=>P(i)));return{function:e,context:r,args:a}}static async deserialize(e){let r=await k.deserialize(e.function),a=new Map(await Promise.all(Object.entries(e.context).map(async([n,d])=>[n,await A(d)]))),i=await Promise.all(e.args.map(n=>A(n)));return new T({function:r,context:a,args:i})}async run(){return await R(this)}};var te=async t=>{let e=await g(t),r=e.system,a=Object.fromEntries(await Promise.all(Object.entries(e.env??{}).map(async([l,C])=>[l,await b(C)]))),i=await b(e.command),n=await Promise.all((e.args??[]).map(async l=>await b(l))),d=e.unsafe??!1;return await new z({system:r,env:a,command:i,args:n,unsafe:d}).run()},re=M("output"),z=class{#e;#t;#r;#a;#i;constructor(e){this.#e=e.system,this.#t=e.env,this.#r=e.command,this.#a=e.args,this.#i=e.unsafe}async serialize(){let e=this.#e,r=Object.fromEntries(await Promise.all(Object.entries(this.#t).map(async([d,l])=>[d,await l.serialize()]))),a=await this.#r.serialize(),i=await Promise.all(this.#a.map(d=>d.serialize())),n=this.#i;return{system:e,env:r,command:a,args:i,unsafe:n}}static async deserialize(e){let r=e.system,a=Object.fromEntries(await Promise.all(Object.entries(e.env).map(async([l,C])=>[l,await s.deserialize(C)]))),i=await s.deserialize(e.command),n=await Promise.all(e.args.map(l=>s.deserialize(l))),d=e.unsafe;return new z({system:r,env:a,command:i,args:n,unsafe:d})}async run(){return await R(this)}};var R=async t=>{let e=await ce(t),r=await syscall("run",e);return await A(r)},ce=async t=>{if(t instanceof V)return{kind:"download",value:await t.serialize()};if(t instanceof z)return{kind:"process",value:await t.serialize()};if(t instanceof T)return{kind:"call",value:await t.serialize()};throw new Error("Cannot serialize operation.")};var ae=async t=>await new V(t).run();var V=class{#e;#t;#r;#a;constructor(e){this.#e=e.url,this.#t=e.unpack??!1,this.#r=e.checksum??null,this.#a=e.unsafe??!1}async serialize(){return{url:this.#e,unpack:this.#t,checksum:this.#r,unsafe:this.#a}}static async deserialize(e){return new V({url:e.url,unpack:e.unpack,checksum:e.checksum,unsafe:e.unsafe})}async run(){return await R(this)}};var $=(...t)=>{let e=t.map(r=>me(r)).join(" ");syscall("log",e)},me=t=>L(t,new Set),L=(t,e)=>{switch(typeof t){case"string":return`"${t}"`;case"number":return t.toString();case"boolean":return t?"true":"false";case"undefined":return"undefined";case"object":return ue(t,e);case"function":return`[function ${t.name??"(anonymous)"}]`;case"symbol":return"[symbol]";case"bigint":return t.toString()}},ue=(t,e)=>{if(t===null)return"null";if(e.has(t))return"[circular]";if(e.add(t),Array.isArray(t))return`[${t.map(r=>L(r,e)).join(", ")}]`;if(t instanceof Error)return t.stack??"";if(t instanceof Promise)return"[promise]";{let r="";t.constructor!==void 0&&t.constructor.name!=="Object"&&(r=`${t.constructor.name} `);let a=Object.entries(t).map(([i,n])=>`${i}: ${L(n,e)}`);return`${r}{ ${a.join(", ")} }`}};var pe={log:$},fe={Directory:o,File:c,Path:H,Placeholder:m,Reference:p,Symlink:f,Template:s,context:U,directory:F,download:ae,file:j,function:Z,isDirectory:v,isFile:D,isPath:q,isPlaceholder:W,isReference:E,isSymlink:I,isTemplate:Y,log:$,output:re,path:h,placeholder:M,process:te,reference:J,resolve:g,symlink:Q,template:b};Object.defineProperties(globalThis,{console:{value:pe},t:{value:X},tg:{value:fe}});})();
