"use strict";(()=>{var S=async e=>await syscall("add_blob",e),K=async e=>await syscall("get_blob",e);var d=(e,t)=>{if(!e)throw t=t??"Failed assertion.",new Error(t)};var N=e=>e instanceof Uint8Array||typeof e=="string"||e instanceof c,M=async(e,t)=>{e=await e;let r,a;return e instanceof Uint8Array?r=await S(e):typeof e=="string"?r=await S(syscall("encode_utf8",e)):(r=e.blobHash(),a=e.executable()),a=t?.executable??a,new c(r,{executable:a})},D=e=>e instanceof c,c=class{#e;#t;constructor(t,r){this.#e=t,this.#t=r?.executable??!1}static async fromHash(t){let r=await p(t);return d(D(r)),r}async serialize(){let t=this.#e,r=this.#t;return{blobHash:t,executable:r}}static async deserialize(t){let r=t.blobHash,a=t.executable;return new c(r,{executable:a})}blobHash(){return this.#e}executable(){return this.#t}async getBytes(){return await K(this.#e)}async getString(){let t=await this.getBytes();return syscall("decode_utf8",t)}};var h=e=>new H(e),G=e=>e instanceof H,H=class{#e;constructor(t){if(typeof t=="string"){this.#e=[];let r=t.split("/");for(let a of r)a===""||(a==="."?this.#e.push({kind:"current_dir"}):a===".."?this.#e.push({kind:"parent_dir"}):this.#e.push({kind:"normal",value:a}))}else t instanceof Array?this.#e=t:this.#e=t.components()}components(){return[...this.#e]}parent(){let t=h(this);return t.push({kind:"parent_dir"}),t}push(t){this.#e.push(t)}join(t){return h([...this.components(),...h(t).components()])}normalize(){let t=[];for(let r of this.components())switch(r.kind){case"current_dir":break;case"parent_dir":{t.every(a=>a.kind==="parent_dir")?t.push(r):t.pop();break}case"normal":{t.push(r);break}}return h(t)}toString(){let t=[];for(let r of this.components())switch(r.kind){case"current_dir":{t.push(".");break}case"parent_dir":{t.push("..");break}case"normal":{t.push(r.value);break}}return t.join("/")}};var _=e=>new m(e),q=e=>e instanceof m,m=class{name;constructor(t){this.name=t}async serialize(){return{name:this.name}}static async deserialize(t){let r=t.name;return new m(r)}};var J=async e=>{let t=await w(await e.artifact),r=O(e.path)?e.path:h(e.path);return new u({artifactHash:t,path:r})},E=e=>e instanceof u,u=class{#e;#t;constructor(t){this.#e=t.artifactHash,this.#t=t.path}static async fromHash(t){let r=await p(t);return d(E(r)),r}async serialize(){let t=this.#e,r=this.#t?.toString();return{artifactHash:t,path:r}}static async deserialize(t){let r=t.artifactHash,a=O(t.path)?t.path:h(t.path);return new u({artifactHash:r,path:a})}artifactHash(){return this.#e}path(){return this.#t}async getArtifact(){return await p(this.#e)}};var Q=e=>new f(e),I=e=>e instanceof f,f=class{#e;constructor(t){this.#e=t}static async fromHash(t){let r=await p(t);return d(I(r)),r}async serialize(){return{target:this.#e}}static async deserialize(t){return new f(t.target)}target(){return this.#e}};var g=async e=>{if(e=await e,e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof l||e instanceof c||e instanceof f||e instanceof u||e instanceof m||e instanceof o)return e;if(e instanceof Array)return await Promise.all(e.map(t=>g(t)));if(typeof e=="object")return Object.fromEntries(await Promise.all(Object.entries(e).map(async([t,r])=>[t,await g(r)])));if(typeof e=="function")return await g(e());throw new Error("Invalid value to resolve.")};var W=async(e,...t)=>{let r=[];for(let a=0;a<e.length-1;a++){let i=e[a],n=t[a];r.push(i),r.push(n)}return r.push(e[e.length-1]),await x(r)},x=async e=>{let t=await g(e),r=[],a=i=>{i instanceof Array?i.forEach(a):i instanceof o?r.push(...i.components()):r.push(i)};return a(t),new o(r)},X=e=>e instanceof o,o=class{#e;constructor(t){this.#e=t}async serialize(){return{components:await Promise.all(this.#e.map(async r=>await ne(r)))}}static async deserialize(t){return new o(await Promise.all(t.components.map(async r=>await se(r))))}components(){return[...this.#e]}render(t){return this.#e.map(t).join("")}},ne=async e=>{if(typeof e=="string")return{kind:"string",value:e};if(P(e))return{kind:"artifact",value:await w(e)};if(e instanceof m)return{kind:"placeholder",value:await e.serialize()};throw new Error("Invalid template component.")},se=async e=>{switch(e.kind){case"string":return await e.value;case"artifact":return await p(e.value);case"placeholder":return await m.deserialize(e.value)}};var O=e=>e==null;var k=async e=>{if(e==null)return{kind:"null",value:e};if(typeof e=="boolean")return{kind:"bool",value:e};if(typeof e=="number")return{kind:"number",value:e};if(typeof e=="string")return{kind:"string",value:e};if(P(e))return{kind:"artifact",value:await w(e)};if(e instanceof m)return{kind:"placeholder",value:await e.serialize()};if(e instanceof o)return{kind:"template",value:await e.serialize()};if(e instanceof Array)return{kind:"array",value:await Promise.all(e.map(r=>k(r)))};if(typeof e=="object")return{kind:"map",value:Object.fromEntries(await Promise.all(Object.entries(e).map(async([r,a])=>[r,await k(a)])))};throw new Error("Failed to serialize the value.")},A=async e=>{switch(e.kind){case"null":return e.value;case"bool":return e.value;case"number":return e.value;case"string":return e.value;case"artifact":return await p(e.value);case"placeholder":return await m.deserialize(e.value);case"template":return await o.deserialize(e.value);case"array":return await Promise.all(e.value.map(t=>A(t)));case"map":return Object.fromEntries(await Promise.all(Object.entries(e.value).map(async([t,r])=>[t,await A(r)])))}};var U=async(...e)=>{let t=new Map;for(let r of e)if(r=await r,!O(r))if(r instanceof l)for(let[a,i]of r)t.set(a,i);else for(let[a,i]of Object.entries(r)){let[n,...y]=h(a).normalize().components();if(n.kind!=="normal")throw new Error("Invalid path component.");let s=n.value;if(y.length>0){let R=h(y).toString(),$=t.get(s),F;$!==void 0&&(F=await p($),F instanceof l||(F=void 0));let ie=await U(F,{[R]:i});t.set(s,await w(ie))}else i=await i,O(i)?t.delete(s):N(i)?t.set(s,await w(await M(i))):P(i)?t.set(s,await w(i)):t.set(s,await w(await U(i)))}return new l(t)},v=e=>e instanceof l,l=class{#e;constructor(t){this.#e=t}static async fromHash(t){let r=await p(t);return d(v(r)),r}async serialize(){return{entries:Object.fromEntries(Array.from(this.#e.entries()))}}static async deserialize(t){let r=new Map(Object.entries(t.entries));return new l(r)}async tryGet(t){let[r,...a]=h(t).normalize().components();if(r.kind!=="normal")throw new Error(`Invalid path "${t}".`);let i=this.#e.get(r.value);if(!i)return null;let n=await p(i);return a.length>0?(d(v(n)),await n.tryGet(a)):n}async get(t){let r=await this.tryGet(t);if(r===null)throw new Error(`Failed to get directory entry "${t}".`);return r}async getEntries(){let t={};for await(let[r,a]of this)t[r]=await a;return t}*[Symbol.iterator](){for(let[t,r]of this.#e)yield[t,r]}async*[Symbol.asyncIterator](){for(let t of this.#e.keys())yield[t,await this.get(t)]}};var P=e=>e instanceof l||e instanceof c||e instanceof f||e instanceof u,w=async e=>await syscall("add_artifact",await oe(e)),p=async e=>await le(await syscall("get_artifact",e)),oe=async e=>{if(e instanceof l)return{kind:"directory",value:await e.serialize()};if(e instanceof c)return{kind:"file",value:await e.serialize()};if(e instanceof f)return{kind:"symlink",value:await e.serialize()};if(e instanceof u)return{kind:"reference",value:await e.serialize()};throw new Error("Unknown artifact type")},le=async e=>{switch(e.kind){case"directory":return await l.deserialize(e.value);case"file":return await c.deserialize(e.value);case"symlink":return await f.deserialize(e.value);case"reference":return await u.deserialize(e.value)}};var Y=(e,t)=>syscall("checksum",e,t);var j=new Map;var Z=e=>{let t=syscall("get_current_package_instance_hash"),r=syscall("get_current_export_name");return new b({packageInstanceHash:t,name:r,implementation:e})};var b=class extends globalThis.Function{packageInstanceHash;name;implementation;constructor(t){return super(),this.packageInstanceHash=t.packageInstanceHash,this.name=t.name,this.implementation=t.implementation,new Proxy(this,{apply:(r,a,i)=>r._call(...i)})}async serialize(){let t=this.packageInstanceHash,r=this.name?.toString();return{packageInstanceHash:t,name:r}}static async deserialize(t){let r=t.packageInstanceHash,a=t.name;return new b({packageInstanceHash:r,name:a})}async _call(...t){let r=new Map(await j.entries()),a=await Promise.all(t.map(g));return await ee({function:this,context:r,args:a})}async run(t,r){d(this.implementation,"This function does not have an implementation.");for(let[y,s]of Object.entries(r))j.set(y,await A(s));let a=await Promise.all(t.map(A)),i=await this.implementation(...a);return await k(i)}};var ee=async e=>{let t=e.function,r=e.context??new Map,a=e.args??[];return await new T({function:t,context:r,args:a}).run()};var T=class{#e;#t;#r;constructor(t){this.#e=t.function,this.#t=t.context,this.#r=t.args}async serialize(){let t=await this.#e.serialize(),r=Object.fromEntries(await Promise.all(Array.from(this.#t.entries()).map(async([i,n])=>[i,await k(n)]))),a=await Promise.all(this.#r.map(i=>k(i)));return{function:t,context:r,args:a}}static async deserialize(t){let r=await b.deserialize(t.function),a=new Map(await Promise.all(Object.entries(t.context).map(async([n,y])=>[n,await A(y)]))),i=await Promise.all(t.args.map(n=>A(n)));return new T({function:r,context:a,args:i})}async run(){return await C(this)}};var te=async e=>{let t=await g(e),r=t.system,a=Object.fromEntries(await Promise.all(Object.entries(t.env??{}).map(async([s,R])=>[s,await x(R)]))),i=await x(t.command),n=await Promise.all((t.args??[]).map(async s=>await x(s))),y=t.unsafe??!1;return await new z({system:r,env:a,command:i,args:n,unsafe:y}).run()},re=_("output"),z=class{#e;#t;#r;#a;#i;constructor(t){this.#e=t.system,this.#t=t.env,this.#r=t.command,this.#a=t.args,this.#i=t.unsafe}async serialize(){let t=this.#e,r=Object.fromEntries(await Promise.all(Object.entries(this.#t).map(async([y,s])=>[y,await s.serialize()]))),a=await this.#r.serialize(),i=await Promise.all(this.#a.map(y=>y.serialize())),n=this.#i;return{system:t,env:r,command:a,args:i,unsafe:n}}static async deserialize(t){let r=t.system,a=Object.fromEntries(await Promise.all(Object.entries(t.env).map(async([s,R])=>[s,await o.deserialize(R)]))),i=await o.deserialize(t.command),n=await Promise.all(t.args.map(s=>o.deserialize(s))),y=t.unsafe;return new z({system:r,env:a,command:i,args:n,unsafe:y})}async run(){return await C(this)}};var C=async e=>{let t=await ce(e),r=await syscall("run",t);return await A(r)},ce=async e=>await syscall("add_operation",await me(e));var me=async e=>{if(e instanceof V)return{kind:"download",value:await e.serialize()};if(e instanceof z)return{kind:"process",value:await e.serialize()};if(e instanceof T)return{kind:"call",value:await e.serialize()};throw new Error("Cannot serialize operation.")};var ae=async e=>await new V(e).run();var V=class{#e;#t;#r;#a;constructor(t){this.#e=t.url,this.#t=t.unpack??!1,this.#r=t.checksum??null,this.#a=t.unsafe??!1}async serialize(){return{url:this.#e,unpack:this.#t,checksum:this.#r,unsafe:this.#a}}static async deserialize(t){return new V({url:t.url,unpack:t.unpack,checksum:t.checksum,unsafe:t.unsafe})}async run(){return await C(this)}};var L=(...e)=>{let t=e.map(r=>pe(r)).join(" ");syscall("log",t)},pe=e=>B(e,new Set),B=(e,t)=>{switch(typeof e){case"string":return`"${e}"`;case"number":return e.toString();case"boolean":return e?"true":"false";case"undefined":return"undefined";case"object":return ue(e,t);case"function":return`[function ${e.name??"(anonymous)"}]`;case"symbol":return"[symbol]";case"bigint":return e.toString()}},ue=(e,t)=>{if(e===null)return"null";if(t.has(e))return"[circular]";if(t.add(e),e instanceof Array)return`[${e.map(r=>B(r,t)).join(", ")}]`;if(e instanceof Error)return e.stack??"";if(e instanceof Promise)return"[promise]";{let r="";e.constructor!==void 0&&e.constructor.name!=="Object"&&(r=`${e.constructor.name} `);let a=Object.entries(e).map(([i,n])=>`${i}: ${B(n,t)}`);return`${r}{ ${a.join(", ")} }`}};var fe={log:L},ye={Directory:l,File:c,Path:H,Placeholder:m,Reference:u,Symlink:f,Template:o,checksum:Y,context:j,directory:U,download:ae,file:M,function:Z,isArtifact:P,isDirectory:v,isFile:D,isPath:G,isPlaceholder:q,isReference:E,isSymlink:I,isTemplate:X,log:L,output:re,path:h,placeholder:_,process:te,reference:J,resolve:g,symlink:Q,template:x};Object.defineProperties(globalThis,{console:{value:fe},t:{value:W},tg:{value:ye}});})();
