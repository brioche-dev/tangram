"use strict";(()=>{var be=Object.defineProperty;var we=(t,e)=>{for(var n in e)be(t,n,{get:e[n],enumerable:!0})};var o=(t,e)=>{if(!t)throw new Error(e??"Failed assertion.")},Y=t=>{throw new Error(t??"Reached unimplemented code.")},m=t=>{throw new Error(t??"Reached unreachable code.")};var H={};we(H,{base64:()=>ae,hex:()=>D,json:()=>v,toml:()=>se,utf8:()=>I,yaml:()=>ie});var Z=async t=>{try{return await syscall("build",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},ee=async t=>{try{return await syscall("bundle",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var te=async(t,e)=>{try{return await syscall("download",t,e)}catch(n){throw new Error("The syscall failed.",{cause:n})}},k={base64:{decode:t=>{try{return syscall("encoding_base64_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_base64_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},hex:{decode:t=>{try{return syscall("encoding_hex_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_hex_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},json:{decode:t=>{try{return syscall("encoding_json_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_json_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},toml:{decode:t=>{try{return syscall("encoding_toml_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_toml_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},utf8:{decode:t=>{try{return syscall("encoding_utf8_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_utf8_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},yaml:{decode:t=>{try{return syscall("encoding_yaml_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_yaml_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}}},re=t=>{try{return syscall("log",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var G=async t=>{try{return await syscall("read",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var ne=async(t,e)=>{try{return await syscall("unpack",t,e)}catch(n){throw new Error("The syscall failed.",{cause:n})}};var ae;(n=>(n.decode=r=>k.base64.decode(r),n.encode=r=>k.base64.encode(r)))(ae||={});var D;(n=>(n.decode=r=>k.hex.decode(r),n.encode=r=>k.hex.encode(r)))(D||={});var v;(n=>(n.decode=r=>k.json.decode(r),n.encode=r=>k.json.encode(r)))(v||={});var se;(n=>(n.decode=r=>k.toml.decode(r),n.encode=r=>k.toml.encode(r)))(se||={});var I;(n=>(n.decode=r=>k.utf8.decode(r),n.encode=r=>k.utf8.encode(r)))(I||={});var ie;(n=>(n.decode=r=>k.yaml.decode(r),n.encode=r=>k.yaml.encode(r)))(ie||={});var g;(e=>{class t{#e;constructor(r){this.#e=r}state(){return this.#e}static withId(r){return new t({id:r,object:void 0})}static withObject(r){return new t({id:void 0,object:r})}expectId(){if(this.#e.id===void 0)throw new Error;return this.#e.id}expectObject(){if(this.#e.object===void 0)throw new Error;return this.#e.object}async id(){return await this.store(),this.#e.id}async object(){return await this.load(),this.#e.object}async load(){this.#e.object===void 0&&(this.#e.object=await syscall("load",this.#e.id))}async store(){this.#e.id===void 0&&(this.#e.id=await syscall("store",this.#e.object))}}e.Handle=t})(g||={});var U=t=>t.flat(1/0);var $=async(...t)=>await A.new(...t),A=class t{#e;constructor(e){this.#e=e}static async new(...e){let{contents:n,executable:r,references:a}=U(await Promise.all(e.map(async function i(l){let c=await b(l);return f.Arg.is(c)?{contents:c}:t.is(c)?{contents:await c.contents(),executable:await c.executable(),references:await c.references()}:c instanceof Array?await Promise.all(c.map(i)):typeof c=="object"?{contents:c.contents,executable:c.executable,references:c.references}:m()}))).reduce((i,{contents:l,executable:c,references:u})=>(i.contents.push(l),i.executable=c!==void 0?c:i.executable,i.references.push(...u??[]),i),{contents:[],executable:!1,references:[]}),s=await M(...n);return new t(g.Handle.withObject({kind:"file",value:{contents:s,executable:r,references:a}}))}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="file"),e.value}handle(){return this.#e}async contents(){return(await this.object()).contents}async executable(){return(await this.object()).executable}async references(){return(await this.object()).references}async size(){return(await this.contents()).size()}async bytes(){return(await this.contents()).bytes()}async text(){return(await this.contents()).text()}};var S=class t{#e;constructor(e){this.#e=e}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="package"),e.value}handle(){return this.#e}async artifact(){return(await this.object()).artifact}async dependencies(){return(await this.object()).dependencies}};var z=t=>j.new(t),j=class t{#e;constructor(e){this.#e=e}static new(e){return new t(e)}static is(e){return e instanceof t}name(){return this.#e}};var P=(...t)=>E.new(...t),O=(...t)=>R.new(...t),E=class t{#e;#t;constructor(e){this.#e=e?.parents??0,this.#t=e?.subpath??new R}static new(...e){return e.reduce(function n(r,a){if(typeof a=="string")for(let s of a.split("/"))s===""||s==="."||(s===".."?r=r.parent():r.#t.push(s));else if(a instanceof t){for(let s=0;s<a.#e;s++)r.parent();r.#t.join(a.#t)}else if(a instanceof R)r.#t.join(a);else if(a instanceof Array)a.forEach(s=>n(r,s));else return m();return r},new t)}static is(e){return e instanceof t}isEmpty(){return this.#e==0&&this.#t.isEmpty()}parents(){return this.#e}subpath(){return this.#t}parent(){return this.#t.isEmpty()?this.#e+=1:this.#t.pop(),this}join(e){e=t.new(e);for(let n=0;n<e.#e;n++)this.parent();return this.#t.join(e.#t),this}extension(){return this.#t.extension()}toSubpath(){if(this.#e>0)throw new Error("Cannot convert to subpath.");return this.#t}toString(){let e="";for(let n=0;n<this.#e;n++)e+="../";return e+=this.#t.toString(),e}};(e=>{let t;(s=>(s.is=i=>i===void 0||typeof i=="string"||i instanceof R||i instanceof e||i instanceof Array&&i.every(e.Arg.is),s.expect=i=>(o((0,s.is)(i)),i),s.assert=i=>{o((0,s.is)(i))}))(t=e.Arg||={})})(E||={});var R=class t{#e;constructor(e){this.#e=e??[]}static new(...e){return E.new(...e).toSubpath()}static is(e){return e instanceof t}components(){return[...this.#e]}isEmpty(){return this.#e.length==0}join(e){return this.#e.push(...e.#e),this}push(e){this.#e.push(e)}pop(){this.#e.pop()}extension(){return this.#e.at(-1)?.split(".").at(-1)}toRelpath(){return E.new(this)}toString(){return this.#e.join("/")}};var C=async(t,...e)=>{let n=[];for(let r=0;r<t.length-1;r++){let a=t[r];n.push(a);let s=e[r];n.push(s)}return n.push(t[t.length-1]),await V(...n)},V=(...t)=>y.new(...t),y=class t{#e;constructor(e){this.#e=e}static async new(...e){let n=U(await Promise.all(e.map(async function r(a){return a=await b(a),t.Component.is(a)?a:a instanceof t?a.components():a instanceof Array?await Promise.all(a.map(r)):m()}))).reduce((r,a)=>(r.push(a),r),[]);return n=n.reduce((r,a)=>{let s=r.at(-1);return a===""||(typeof s=="string"&&typeof a=="string"?r.splice(-1,1,s+a):r.push(a)),r},[]),new t(n)}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}static async join(e,...n){let r=await V(e),a=await Promise.all(n.map(i=>V(i)));a=a.filter(i=>i.components().length>0);let s=[];for(let i=0;i<a.length;i++){i>0&&s.push(r);let l=a[i];o(l),s.push(l)}return V(...s)}components(){return[...this.#e]}};(e=>{let t;(r=>r.is=a=>typeof a=="string"||_.is(a)||a instanceof j)(t=e.Component||={})})(y||={});var q=async(...t)=>await w.new(...t),w=class t{#e;constructor(e){this.#e=e}static async new(...e){let{artifact:n,path:r}=U(await Promise.all(e.map(async function s(i){let l=await b(i);if(typeof l=="string")return{path:P(l)};if(_.is(l))return{artifact:l};if(l instanceof y){o(l.components().length<=2);let[c,u]=l.components();if(typeof c=="string"&&u===void 0)return{path:P(c)};if(_.is(c)&&u===void 0)return{artifact:c};if(_.is(c)&&typeof u=="string")return o(u.startsWith("/")),{artifact:c,path:P(u.slice(1))};throw new Error("Invalid template.")}else return l instanceof t?{artifact:await l.artifact(),path:await l.path()}:l instanceof Array?await Promise.all(l.map(s)):typeof l=="object"?{artifact:l.artifact,path:P(l.path)}:m()}))).reduce((s,{artifact:i,path:l})=>(i!==void 0?(s.artifact=i,s.path=l??P()):s.path=s.path.join(l),s),{artifact:void 0,path:P()}),a;if(n!==void 0&&!r.isEmpty())a=await C`${n}/${r.toString()}`;else if(n!==void 0)a=await C`${n}`;else if(!r.isEmpty())a=await C`${r.toString()}`;else throw new Error("Invalid symlink.");return new t(g.Handle.withObject({kind:"symlink",value:{target:a}}))}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="symlink"),e.value}handle(){return this.#e}async target(){return(await this.object()).target}async artifact(){let n=(await this.target()).components().at(0);if(_.is(n))return n}async path(){let e=await this.target(),[n,r]=e.components();if(typeof n=="string"&&r===void 0)return P(n);if(_.is(n)&&r===void 0)return P();if(_.is(n)&&typeof r=="string")return P(r.slice(1));throw new Error("Invalid template.")}async resolve(e){e=e?await q(e):void 0;let n=await e?.artifact();n instanceof t&&(n=await n.resolve());let r=e?.path(),a=await this.artifact();a instanceof t&&(a=await a.resolve());let s=await this.path();if(a!==void 0&&s.isEmpty())return a;if(a===void 0&&!s.isEmpty()){if(!(n instanceof p))throw new Error("Expected a directory.");return await n.tryGet((await(r??P())).parent().join(s).toSubpath().toString())}else if(a!==void 0&&!s.isEmpty()){if(!(a instanceof p))throw new Error("Expected a directory.");return await a.tryGet(s.toSubpath().toString())}else throw new Error("Invalid symlink.")}};var L={};function oe(...t){if(t.length===1&&typeof t[0]=="object"&&"function"in t[0]){let e=t[0],n=v.encode({module:{package:e.module.package.handle().expectId(),path:e.module.path},name:e.name});return o(L[n]===void 0),L[n]=e.function,T.new({host:"js-js",executable:e.module.path,package:e.module.package,name:e.name})}else return T.new(...t)}var ce=async(...t)=>await(await T.new(...t)).build(),le=z("output"),T=class t extends globalThis.Function{#e;constructor(e){super(),this.#e=e;let n=this;return new Proxy(n,{get(r,a,s){return typeof n[a]=="function"?n[a].bind(n):n[a]},apply:async(r,a,s)=>await(await t.new(n,{args:s})).build(),getPrototypeOf:r=>Object.getPrototypeOf(n)})}static async new(...e){let{host:n,executable:r,package_:a,name:s,env:i,args_:l,checksum:c,unsafe_:u}=U(await Promise.all(e.map(async function h(d){let x=await b(d);return x instanceof y?{}:x instanceof t?{}:x instanceof Array?await Promise.all(x.map(h)):typeof x=="object"?{host:x.host,executable:await V(x.executable),package_:x.package,name:s,env:i,args_:l,checksum:c,unsafe_:u}:m()}))).reduce((h,d)=>({host:h.host??d.host,executable:h.executable??d.executable,package_:h.package_??d.package_,name:h.name??d.name,env:{...h.env??{},...d.env??{}},args_:[...h.args_??[],...d.args_??[]],checksum:h.checksum??d.checksum,unsafe_:h.unsafe_??d.unsafe_}),{});if(!n)throw new Error("Cannot create a target without a host.");if(!r)throw new Error("Cannot create a target without an executable.");return i??={},l??=[],u??=!1,new t(g.Handle.withObject({kind:"target",value:{host:n,executable:r,package:a,name:s,env:i,args:l,checksum:c,unsafe:u}}))}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="target"),e.value}handle(){return this.#e}async host(){return(await this.object()).host}async executable(){return(await this.object()).executable}async package(){return(await this.object()).package}async name_(){return(await this.object()).name}async env(){return(await this.object()).env}async args(){return(await this.object()).args}async checksum(){return(await this.object()).checksum}async unsafe(){return(await this.object()).unsafe}async build(...e){return await Z(await t.new(this,{args:e}))}};var b=async t=>{if(t=await t,t===void 0||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Uint8Array||t instanceof f||t instanceof p||t instanceof A||t instanceof w||t instanceof j||t instanceof y||t instanceof S||t instanceof T)return t;if(t instanceof Array)return await Promise.all(t.map(e=>b(e)));if(typeof t=="object")return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,n])=>[e,await b(n)])));throw new Error("Invalid value to resolve.")};var M=async(...t)=>await f.new(...t),f=class t{#e;constructor(e){this.#e=e}static async new(...e){let n=U(await Promise.all(e.map(async function r(a){let s=await b(a);return s===void 0?[]:typeof s=="string"?new t(g.Handle.withObject({kind:"blob",value:I.encode(s)})):s instanceof Uint8Array?new t(g.Handle.withObject({kind:"blob",value:s})):s instanceof t?s:s instanceof Array?await Promise.all(s.map(r)):m()})));return n.length===0?new t(g.Handle.withObject({kind:"blob",value:new Uint8Array})):n.length===1?n[0]:new t(g.Handle.withObject({kind:"blob",value:await Promise.all(n.map(async r=>[r,await r.size()]))}))}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="blob"),e.value}handle(){return this.#e}async size(){let e=await this.object();return e instanceof Array?e.map(([n,r])=>r).reduce((n,r)=>n+r,0):e.byteLength}async bytes(){return await G(this)}async text(){return I.decode(await G(this))}};(e=>{let t;(s=>(s.is=i=>i===void 0||typeof i=="string"||i instanceof Uint8Array||i instanceof e||i instanceof Array&&i.every(s.is),s.expect=i=>(o((0,s.is)(i)),i),s.assert=i=>{o((0,s.is)(i))}))(t=e.Arg||={})})(f||={});var ue=async(...t)=>await p.new(...t),p=class t{#e;constructor(e){this.#e=e}static async new(...e){let n=await(await Promise.all(e.map(b))).reduce(async function r(a,s){let i=await a;if(s!==void 0)if(t.is(s))for(let[l,c]of Object.entries(await s.entries())){let u=i[l];t.is(u)&&t.is(c)&&(c=await t.new(u,c)),i[l]=c}else if(s instanceof Array)for(let l of s)i=await r(Promise.resolve(i),l);else if(typeof s=="object")for(let[l,c]of Object.entries(s)){let[u,...h]=O(l).components();if(u===void 0)throw new Error("The path must have at least one component.");let d=u,x=i[d];if(t.is(x)||(x=void 0),h.length>0){let N=O(h).toString(),ge=await t.new(x,{[N]:c});i[d]=ge}else if(c===void 0)delete i[d];else if(f.Arg.is(c)){let N=await $(c);i[d]=N}else if(A.is(c)||w.is(c))i[d]=c;else{let N=await t.new(x,c);i[d]=N}}else return m();return i},Promise.resolve({}));return new t(g.Handle.withObject({kind:"directory",value:{entries:n}}))}static is(e){return e instanceof t}static expect(e){return o(t.is(e)),e}static assert(e){o(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return o(e.kind==="directory"),e.value}handle(){return this.#e}async get(e){let n=await this.tryGet(e);return o(n,`Failed to get the directory entry "${e}".`),n}async tryGet(e){let n=await this.object(),r=this,a=O();for(let s of O(e).components()){if(!t.is(r))return;a.push(s);let i=n.entries[s];if(i===void 0)return;if(w.is(i)){let l=await i.resolve({artifact:this,path:a.toString()});if(l===void 0)return;r=l}else r=i}return r}async entries(){let e={};for await(let[n,r]of this)e[n]=r;return e}async bundle(){return await ee(this)}async*walk(){for await(let[e,n]of this)if(yield[O(e),n],t.is(n))for await(let[r,a]of n.walk())yield[O(e).join(r),a]}async*[Symbol.asyncIterator](){let e=await this.object();for(let[n,r]of Object.entries(e.entries))yield[n,r]}};var _;(r=>(r.is=a=>p.is(a)||A.is(a)||w.is(a),r.expect=a=>(o((0,r.is)(a)),a),r.assert=a=>{o((0,r.is)(a))}))(_||={});var de=async(t,e)=>await te(t,e),me=async(t,e)=>await ne(t,e);var K=class{message;location;stack;source;constructor(e,n,r,a){this.message=e,this.location=n,this.stack=r,this.source=a}},pe=(t,e)=>({callSites:e.map(r=>({typeName:r.getTypeName(),functionName:r.getFunctionName(),methodName:r.getMethodName(),fileName:r.getFileName(),lineNumber:r.getLineNumber(),columnNumber:r.getColumnNumber(),isEval:r.isEval(),isNative:r.isNative(),isConstructor:r.isConstructor(),isAsync:r.isAsync(),isPromiseAll:r.isPromiseAll(),promiseIndex:r.getPromiseIndex()}))});var fe=async t=>{let e=await t.module.package.artifact();p.assert(e);let n=O(t.module.path).toRelpath().parent().join(t.path).toSubpath().toString();return await e.get(n)};var J=(...t)=>{let e=t.map(n=>Ae(n)).join(" ");re(e)},Ae=t=>W(t,new WeakSet),W=(t,e)=>{switch(typeof t){case"string":return`"${t}"`;case"number":return t.toString();case"boolean":return t?"true":"false";case"undefined":return"undefined";case"object":return t===null?"null":ye(t,e);case"function":return`(function "${t.name??"(anonymous)"}")`;case"symbol":return"(symbol)";case"bigint":return t.toString()}},ye=(t,e)=>{if(e.has(t))return"(circular)";if(e.add(t),t instanceof Array)return`[${t.map(n=>W(n,e)).join(", ")}]`;if(t instanceof Error)return t.message;if(t instanceof Promise)return"(promise)";if(t instanceof f)return`(tg.blob ${B(t.handle(),e)})`;if(t instanceof p)return`(tg.directory ${B(t.handle(),e)})`;if(t instanceof A)return`(tg.file ${B(t.handle(),e)})`;if(t instanceof w)return`(tg.symlink ${B(t.handle(),e)})`;if(t instanceof j)return`(tg.placeholder "${t.name()}")`;if(t instanceof y)return`(tg.template "${t.components().map(r=>typeof r=="string"?r:`\${${W(r,e)}}`).join("")}")`;if(t instanceof S)return`(tg.package "${B(t.handle(),e)}")`;if(t instanceof T)return`(tg.target "${B(t.handle(),e)}")`;{let n="";t.constructor!==void 0&&t.constructor.name!=="Object"&&(n=`${t.constructor.name} `);let r=Object.entries(t).map(([a,s])=>`${a}: ${W(s,e)}`);return`${n}{ ${r.join(", ")} }`}},B=(t,e)=>{let{id:n,object:r}=t.state();return n!==void 0?n:r!==void 0?ye(r,e):m()};var he=t=>{if(typeof t=="string")return t;{let{arch:e,os:n}=t;return`${e}-${n}`}},Q;(r=>(r.is=a=>a==="aarch64-darwin"||a==="aarch64-linux"||a==="js-js"||a==="x86_64-darwin"||a==="x86_64-linux",r.arch=a=>{switch(a){case"aarch64-darwin":case"aarch64-linux":return"aarch64";case"js-js":return"js";case"x86_64-linux":case"x86_64-darwin":return"x86_64";default:throw new Error("Invalid system.")}},r.os=a=>{switch(a){case"aarch64-darwin":case"x86_64-darwin":return"darwin";case"js-js":return"js";case"x86_64-linux":case"aarch64-linux":return"linux";default:throw new Error("Invalid system.")}}))(Q||={});var X;(r=>(r.is=a=>a===void 0||typeof a=="boolean"||typeof a=="number"||typeof a=="string"||a instanceof Uint8Array||a instanceof f||a instanceof p||a instanceof A||a instanceof w||a instanceof j||a instanceof y||a instanceof S||a instanceof T||a instanceof Array||typeof a=="object",r.expect=a=>(o((0,r.is)(a)),a),r.assert=a=>{o((0,r.is)(a))}))(X||={});var xe=async t=>{let n=await(await t.package())?.id(),a=(await t.executable()).components()[0],s={kind:"normal",value:{package:n,path:a}};await import(`tangram://${D.encode(I.encode(v.encode(s)))}/${a}`);let c=await t.name_();if(!c)throw new Error("The target must have a name.");let u=v.encode({module:{package:n,path:a},name:c}),h=L[u];if(!h)throw new Error("Failed to find the function.");let d=await t.args();return await h(...d)};Object.defineProperties(Error,{prepareStackTrace:{value:pe}});var ke={log:J};Object.defineProperties(globalThis,{console:{value:ke}});var je={Artifact:_,Blob:f,Directory:p,Error:K,File:A,Object_:g,Package:S,Placeholder:j,Relpath:E,Subpath:R,Symlink:w,System:Q,Target:T,Template:y,Value:X,assert:o,blob:M,build:ce,directory:ue,download:de,encoding:H,file:$,include:fe,log:J,main:xe,output:le,placeholder:z,relpath:P,resolve:b,subpath:O,symlink:q,system:he,target:oe,template:V,unimplemented:Y,unpack:me,unreachable:m};Object.defineProperties(globalThis,{tg:{value:je},t:{value:C}});})();
//# sourceMappingURL=global.js.map
