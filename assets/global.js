"use strict";(()=>{var xe=Object.defineProperty;var ke=(t,e)=>{for(var r in e)xe(t,r,{get:e[r],enumerable:!0})};var i=(t,e)=>{if(!t)throw new Error(e??"Failed assertion.")},ee=t=>{throw new Error(t??"Reached unimplemented code.")},p=t=>{throw new Error(t??"Reached unreachable code.")},H=()=>{throw new Error("Reached todo.")};var M={};ke(M,{base64:()=>oe,hex:()=>$,json:()=>I,toml:()=>ie,utf8:()=>v,yaml:()=>ce});var te=async t=>{try{return await syscall("bundle",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var re=async(t,e)=>{try{return await syscall("download",t,e)}catch(r){throw new Error("The syscall failed.",{cause:r})}},A={base64:{decode:t=>{try{return syscall("encoding_base64_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_base64_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},hex:{decode:t=>{try{return syscall("encoding_hex_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_hex_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},json:{decode:t=>{try{return syscall("encoding_json_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_json_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},toml:{decode:t=>{try{return syscall("encoding_toml_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_toml_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},utf8:{decode:t=>{try{return syscall("encoding_utf8_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_utf8_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},yaml:{decode:t=>{try{return syscall("encoding_yaml_decode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},encode:t=>{try{return syscall("encoding_yaml_encode",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}}},ne=t=>{try{return syscall("log",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var J=async t=>{try{return await syscall("read",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},ae=async t=>{try{return await syscall("run",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}};var se=async(t,e)=>{try{return await syscall("unpack",t,e)}catch(r){throw new Error("The syscall failed.",{cause:r})}};var oe;(r=>(r.decode=n=>A.base64.decode(n),r.encode=n=>A.base64.encode(n)))(oe||={});var $;(r=>(r.decode=n=>A.hex.decode(n),r.encode=n=>A.hex.encode(n)))($||={});var I;(r=>(r.decode=n=>A.json.decode(n),r.encode=n=>A.json.encode(n)))(I||={});var ie;(r=>(r.decode=n=>A.toml.decode(n),r.encode=n=>A.toml.encode(n)))(ie||={});var v;(r=>(r.decode=n=>A.utf8.decode(n),r.encode=n=>A.utf8.encode(n)))(v||={});var ce;(r=>(r.decode=n=>A.yaml.decode(n),r.encode=n=>A.yaml.encode(n)))(ce||={});var f;(e=>{class t{#e;constructor(n){this.#e=n}state(){return this.#e}static withId(n){return new t({id:n,object:void 0})}static withObject(n){return new t({id:void 0,object:n})}expectId(){if(this.#e.id===void 0)throw new Error;return this.#e.id}expectObject(){if(this.#e.object===void 0)throw new Error;return this.#e.object}async id(){return await this.store(),this.#e.id}async object(){return await this.load(),this.#e.object}async load(){this.#e.object===void 0&&(this.#e.object=await syscall("load",this.#e.id))}async store(){this.#e.id===void 0&&(this.#e.id=await syscall("store",this.#e.object))}}e.Handle=t})(f||={});var U=t=>t.flat(1/0);var z=async(...t)=>await g.new(...t),g=class t{#e;constructor(e){this.#e=e}static async new(...e){let{contents:r,executable:n,references:a}=U(await Promise.all(e.map(async function o(l){let c=await y(l);return m.Arg.is(c)?{contents:c}:t.is(c)?{contents:await c.contents(),executable:await c.executable(),references:await c.references()}:c instanceof Array?await Promise.all(c.map(o)):c instanceof Object?{contents:c.contents,executable:c.executable,references:c.references}:p()}))).reduce((o,{contents:l,executable:c,references:d})=>(o.contents.push(l),o.executable=c!==void 0?c:o.executable,o.references.push(...d??[]),o),{contents:[],executable:!1,references:[]}),s=await L(...r);return new t(f.Handle.withObject({kind:"file",value:{contents:s,executable:n,references:a}}))}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="file"),e.value}handle(){return this.#e}async contents(){return(await this.object()).contents}async executable(){return(await this.object()).executable}async references(){return(await this.object()).references}async size(){return(await this.contents()).size()}async bytes(){return(await this.contents()).bytes()}async text(){return(await this.contents()).text()}};var T=class t{#e;constructor(e){this.#e=e}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="package"),e.value}handle(){return this.#e}async artifact(){return(await this.object()).artifact}async dependencies(){return(await this.object()).dependencies}};var K=t=>x.new(t),x=class t{#e;constructor(e){this.#e=e}static new(e){return new t(e)}static is(e){return e instanceof t}name(){return this.#e}};var k=(...t)=>O.new(...t),P=(...t)=>S.new(...t),O=class t{#e;#t;constructor(e){this.#e=e?.parents??0,this.#t=e?.subpath??new S}static new(...e){return e.reduce(function r(n,a){if(typeof a=="string")for(let s of a.split("/"))s===""||s==="."||(s===".."?n=n.parent():n.#t.push(s));else if(a instanceof t){for(let s=0;s<a.#e;s++)n.parent();n.#t.join(a.#t)}else if(a instanceof S)n.#t.join(a);else if(a instanceof Array)a.forEach(s=>r(n,s));else return p();return n},new t)}static is(e){return e instanceof t}isEmpty(){return this.#e==0&&this.#t.isEmpty()}parents(){return this.#e}subpath(){return this.#t}parent(){return this.#t.isEmpty()?this.#e+=1:this.#t.pop(),this}join(e){e=t.new(e);for(let r=0;r<e.#e;r++)this.parent();return this.#t.join(e.#t),this}extension(){return this.#t.extension()}toSubpath(){if(this.#e>0)throw new Error("Cannot convert to subpath.");return this.#t}toString(){let e="";for(let r=0;r<this.#e;r++)e+="../";return e+=this.#t.toString(),e}};(e=>{let t;(s=>(s.is=o=>o===void 0||typeof o=="string"||o instanceof S||o instanceof e||o instanceof Array&&o.every(e.Arg.is),s.expect=o=>(i((0,s.is)(o)),o),s.assert=o=>{i((0,s.is)(o))}))(t=e.Arg||={})})(O||={});var S=class t{#e;constructor(e){this.#e=e??[]}static new(...e){return O.new(...e).toSubpath()}static is(e){return e instanceof t}components(){return[...this.#e]}isEmpty(){return this.#e.length==0}join(e){return this.#e.push(...e.#e),this}push(e){this.#e.push(e)}pop(){this.#e.pop()}extension(){return this.#e.at(-1)?.split(".").at(-1)}toRelpath(){return O.new(this)}toString(){return this.#e.join("/")}};var C=async(t,...e)=>{let r=[];for(let n=0;n<t.length-1;n++){let a=t[n];r.push(a);let s=e[n];r.push(s)}return r.push(t[t.length-1]),await E(...r)},E=(...t)=>b.new(...t),b=class t{#e;constructor(e){this.#e=e}static async new(...e){let r=U(await Promise.all(e.map(async function n(a){return a=await y(a),t.Component.is(a)?a:a instanceof t?a.components():a instanceof Array?await Promise.all(a.map(n)):p()}))).reduce((n,a)=>(n.push(a),n),[]);return r=r.reduce((n,a)=>{let s=n.at(-1);return a===""||(typeof s=="string"&&typeof a=="string"?n.splice(-1,1,s+a):n.push(a)),n},[]),new t(r)}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}static async join(e,...r){let n=await E(e),a=await Promise.all(r.map(o=>E(o)));a=a.filter(o=>o.components().length>0);let s=[];for(let o=0;o<a.length;o++){o>0&&s.push(n);let l=a[o];i(l),s.push(l)}return E(...s)}components(){return[...this.#e]}};(e=>{let t;(n=>n.is=a=>typeof a=="string"||j.is(a)||a instanceof x)(t=e.Component||={})})(b||={});var Q=async(...t)=>await h.new(...t),h=class t{#e;constructor(e){this.#e=e}static async new(...e){let{artifact:r,path:n}=U(await Promise.all(e.map(async function s(o){let l=await y(o);if(typeof l=="string")return{path:k(l)};if(j.is(l))return{artifact:l};if(l instanceof b){i(l.components().length<=2);let[c,d]=l.components();if(typeof c=="string"&&d===void 0)return{path:k(c)};if(j.is(c)&&d===void 0)return{artifact:c};if(j.is(c)&&typeof d=="string")return i(d.startsWith("/")),{artifact:c,path:k(d.slice(1))};throw new Error("Invalid template.")}else return l instanceof t?{artifact:await l.artifact(),path:await l.path()}:l instanceof Array?await Promise.all(l.map(s)):typeof l=="object"?{artifact:l.artifact,path:k(l.path)}:p()}))).reduce((s,{artifact:o,path:l})=>(o!==void 0?(s.artifact=o,s.path=l??k()):s.path=s.path.join(l),s),{artifact:void 0,path:k()}),a;if(r!==void 0&&!n.isEmpty())a=await C`${r}/${n.toString()}`;else if(r!==void 0)a=await C`${r}`;else if(!n.isEmpty())a=await C`${n.toString()}`;else throw new Error("Invalid symlink.");return new t(f.Handle.withObject({kind:"symlink",value:{target:a}}))}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="symlink"),e.value}handle(){return this.#e}async target(){return(await this.object()).target}async artifact(){let r=(await this.target()).components().at(0);if(j.is(r))return r}async path(){let e=await this.target(),[r,n]=e.components();if(typeof r=="string"&&n===void 0)return k(r);if(j.is(r)&&n===void 0)return k();if(j.is(r)&&typeof n=="string")return k(n.slice(1));throw new Error("Invalid template.")}async resolve(e){e=e?await Q(e):void 0;let r=await e?.artifact();r instanceof t&&(r=await r.resolve());let n=e?.path(),a=await this.artifact();a instanceof t&&(a=await a.resolve());let s=await this.path();if(a!==void 0&&s.isEmpty())return a;if(a===void 0&&!s.isEmpty()){if(!(r instanceof u))throw new Error("Expected a directory.");return await r.tryGet((await(n??k())).parent().join(s).toSubpath().toString())}else if(a!==void 0&&!s.isEmpty()){if(!(a instanceof u))throw new Error("Expected a directory.");return await a.tryGet(s.toSubpath().toString())}else throw new Error("Invalid symlink.")}};var le=async t=>await w.new(t),ue=async t=>await(await w.new(t)).run(),de=K("output"),w=class t{#e;constructor(e){this.#e=e}static async new(e){let r=await y(e),n=r.package,a=r.host,s=await E(r.executable),o=r.target,l=r.env??{},c=r.args??[],d=r.checksum??void 0,R=r.unsafe??!1;return new t(f.Handle.withObject({kind:"task",value:{package:n,host:a,executable:s,target:o,env:l,args:c,checksum:d,unsafe:R}}))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="task"),e.value}handle(){return this.#e}async host(){return(await this.object()).host}async executable(){return(await this.object()).executable}async package(){return(await this.object()).package}async target(){return(await this.object()).target}async env(){return(await this.object()).env}async args(){return(await this.object()).args}async checksum(){return(await this.object()).checksum}async unsafe(){return(await this.object()).unsafe}async run(){return await ae(this)}};var y=async t=>{if(t=await t,t===void 0||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Uint8Array||t instanceof m||t instanceof u||t instanceof g||t instanceof h||t instanceof x||t instanceof b||t instanceof T||t instanceof w)return t;if(t instanceof Array)return await Promise.all(t.map(e=>y(e)));if(typeof t=="object")return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,r])=>[e,await y(r)])));throw new Error("Invalid value to resolve.")};var L=async(...t)=>await m.new(...t),m=class t{#e;constructor(e){this.#e=e}static async new(...e){let r=U(await Promise.all(e.map(async function n(a){let s=await y(a);return s===void 0?[]:typeof s=="string"?new t(f.Handle.withObject({kind:"blob",value:v.encode(s)})):s instanceof Uint8Array?new t(f.Handle.withObject({kind:"blob",value:s})):s instanceof t?s:s instanceof Array?await Promise.all(s.map(n)):p()})));return r.length===0?new t(f.Handle.withObject({kind:"blob",value:new Uint8Array})):r.length===1?r[0]:new t(f.Handle.withObject({kind:"blob",value:await Promise.all(r.map(async n=>[n,await n.size()]))}))}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="blob"),e.value}handle(){return this.#e}async size(){let e=await this.object();return e instanceof Array?e.map(([r,n])=>n).reduce((r,n)=>r+n,0):e.byteLength}async bytes(){return await J(this)}async text(){return v.decode(await J(this))}};(e=>{let t;(s=>(s.is=o=>o===void 0||typeof o=="string"||o instanceof Uint8Array||o instanceof e||o instanceof Array&&o.every(s.is),s.expect=o=>(i((0,s.is)(o)),o),s.assert=o=>{i((0,s.is)(o))}))(t=e.Arg||={})})(m||={});var me=async(...t)=>await u.new(...t),u=class t{#e;constructor(e){this.#e=e}static async new(...e){let r=await(await Promise.all(e.map(y))).reduce(async function n(a,s){let o=await a;if(s!==void 0)if(s instanceof t)for(let[l,c]of Object.entries(await s.entries())){let d=o[l];d instanceof t&&c instanceof t&&(c=await t.new(d,c)),o[l]=c}else if(s instanceof Array)for(let l of s)o=await n(Promise.resolve(o),l);else if(typeof s=="object")for(let[l,c]of Object.entries(s)){let[d,...R]=P(l).components();if(d===void 0)throw new Error("The path must have at least one component.");let _=d,B=o[_];if(B instanceof t||(B=void 0),R.length>0){let N=P(R).toString(),Ae=await t.new(B,{[N]:c});o[_]=Ae}else if(c===void 0)delete o[_];else if(m.Arg.is(c)){let N=await z(c);o[_]=N}else if(g.is(c)||h.is(c))o[_]=c;else{let N=await t.new(B,c);o[_]=N}}else return p();return o},Promise.resolve({}));return new t(f.Handle.withObject({kind:"directory",value:{entries:r}}))}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}async id(){return await this.#e.id()}async object(){let e=await this.#e.object();return i(e.kind==="directory"),e.value}handle(){return this.#e}async get(e){let r=await this.tryGet(e);return i(r,`Failed to get the directory entry "${e}".`),r}async tryGet(e){let r=await this.object(),n=this,a=P();for(let s of P(e).components()){if(!(n instanceof t))return;a.push(s);let o=await r.entries[s];if(o===void 0)return;if(o instanceof h){let l=await o.resolve({artifact:this,path:a.toString()});if(l===void 0)return;n=l}else n=o}return n}async entries(){let e={};for await(let[r,n]of this)e[r]=n;return e}async bundle(){return await te(this)}async*walk(){for await(let[e,r]of this)if(yield[P(e),r],t.is(r))for await(let[n,a]of r.walk())yield[P(e).join(n),a]}async*[Symbol.asyncIterator](){let e=await this.object();for(let[r,n]of Object.entries(e.entries))yield[r,n]}};var j;(a=>(a.withId=async s=>H(),a.is=s=>s instanceof u||s instanceof g||s instanceof h,a.expect=s=>(i((0,a.is)(s)),s),a.assert=s=>{i((0,a.is)(s))}))(j||={});var pe=async(t,e)=>await re(t,e),fe=async(t,e)=>await se(t,e);var W=class{message;location;stack;source;constructor(e,r,n,a){this.message=e,this.location=r,this.stack=n,this.source=a}},ye=(t,e)=>({callSites:e.map(n=>({typeName:n.getTypeName(),functionName:n.getFunctionName(),methodName:n.getMethodName(),fileName:n.getFileName(),lineNumber:n.getLineNumber(),columnNumber:n.getColumnNumber(),isEval:n.isEval(),isNative:n.isNative(),isConstructor:n.isConstructor(),isAsync:n.isAsync(),isPromiseAll:n.isPromiseAll(),promiseIndex:n.getPromiseIndex()}))});var he=async t=>{let e=await t.module.package.artifact();u.assert(e);let r=P(t.module.path).toRelpath().parent().join(t.path).toSubpath().toString();return await e.get(r)};var X=(...t)=>{let e=t.map(r=>je(r)).join(" ");ne(e)},je=t=>G(t,new WeakSet),G=(t,e)=>{switch(typeof t){case"string":return`"${t}"`;case"number":return t.toString();case"boolean":return t?"true":"false";case"undefined":return"undefined";case"object":return t===null?"null":ge(t,e);case"function":return`(function "${t.name??"(anonymous)"}")`;case"symbol":return"(symbol)";case"bigint":return t.toString()}},ge=(t,e)=>{if(e.has(t))return"(circular)";if(e.add(t),t instanceof Array)return`[${t.map(r=>G(r,e)).join(", ")}]`;if(t instanceof Error)return t.message;if(t instanceof Promise)return"(promise)";if(t instanceof m)return`(tg.blob ${V(t.handle(),e)})`;if(t instanceof u)return`(tg.directory ${V(t.handle(),e)})`;if(t instanceof g)return`(tg.file ${V(t.handle(),e)})`;if(t instanceof h)return`(tg.symlink ${V(t.handle(),e)})`;if(t instanceof x)return`(tg.placeholder "${t.name()}")`;if(t instanceof b)return`(tg.template "${t.components().map(n=>typeof n=="string"?n:`\${${G(n,e)}}`).join("")}")`;if(t instanceof T)return`(tg.package "${V(t.handle(),e)}")`;if(t instanceof w)return`(tg.task "${V(t.handle(),e)}")`;{let r="";t.constructor!==void 0&&t.constructor.name!=="Object"&&(r=`${t.constructor.name} `);let n=Object.entries(t).map(([a,s])=>`${a}: ${G(s,e)}`);return`${r}{ ${n.join(", ")} }`}},V=(t,e)=>{let{id:r,object:n}=t.state();return r!==void 0?r:n!==void 0?ge(n,e):p()};var be=t=>{if(typeof t=="string")return t;{let{arch:e,os:r}=t;return`${e}-${r}`}},Y;(n=>(n.is=a=>a==="aarch64-darwin"||a==="aarch64-linux"||a==="js-js"||a==="x86_64-darwin"||a==="x86_64-linux",n.arch=a=>{switch(a){case"aarch64-darwin":case"aarch64-linux":return"aarch64";case"js-js":return"js";case"x86_64-linux":case"x86_64-darwin":return"x86_64";default:throw new Error("Invalid system.")}},n.os=a=>{switch(a){case"aarch64-darwin":case"x86_64-darwin":return"darwin";case"js-js":return"js";case"x86_64-linux":case"aarch64-linux":return"linux";default:throw new Error("Invalid system.")}}))(Y||={});var q={},we=t=>{let e=new D({module:t.module,name:t.name}),r=I.encode({module:{package:t.module.package.handle().expectId(),path:t.module.path},name:t.name});return i(q[r]===void 0),q[r]=t.function,e},D=class t extends globalThis.Function{#e;#t;constructor(e){return super(),this.#e=e.module,this.#t=e.name,new Proxy(this,{apply:async(r,n,a)=>await(await w.new({host:"js-js",executable:r.#e.path,package:r.#e.package,target:r.#t,args:a,env:H()})).run()})}static is(e){return e instanceof t}static expect(e){return i(t.is(e)),e}static assert(e){i(t.is(e))}};var Z;(n=>(n.is=a=>a===void 0||typeof a=="boolean"||typeof a=="number"||typeof a=="string"||a instanceof Uint8Array||a instanceof m||a instanceof u||a instanceof g||a instanceof h||a instanceof x||a instanceof b||a instanceof T||a instanceof w||a instanceof Array||typeof a=="object",n.expect=a=>(i((0,n.is)(a)),a),n.assert=a=>{i((0,n.is)(a))}))(Z||={});var Pe=async t=>{let r=await(await t.package())?.id(),a=(await t.executable()).components()[0],s={kind:"normal",value:{package:r,path:a}};await import(`tangram://${$.encode(v.encode(I.encode(s)))}/${a}`);let c=await t.target();if(!c)throw new Error("The task must have a target.");let d=I.encode({module:{package:r,path:a},name:c}),R=q[d];if(!R)throw new Error("Failed to find the function.");let _=await t.args();return await R(..._)};Object.defineProperties(Error,{prepareStackTrace:{value:ye}});var Te={log:X};Object.defineProperties(globalThis,{console:{value:Te}});var Oe={Artifact:j,Blob:m,Directory:u,Error:W,File:g,Object_:f,Package:T,Placeholder:x,Relpath:O,Subpath:S,Symlink:h,System:Y,Target:D,Task:w,Template:b,Value:Z,assert:i,blob:L,directory:me,download:pe,encoding:M,file:z,include:he,log:X,main:Pe,output:de,placeholder:K,relpath:k,resolve:y,run:ue,subpath:P,symlink:Q,system:be,target:we,task:le,template:E,unimplemented:ee,unpack:fe,unreachable:p};Object.defineProperties(globalThis,{tg:{value:Oe},t:{value:C}});})();
//# sourceMappingURL=global.js.map
