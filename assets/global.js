"use strict";(()=>{var A=(n,e)=>{if(!n)throw new Error(e??"Failed assertion.")},k=n=>{throw new Error(n??"Reached unreachable code.")};var B={bundle:async n=>{try{return await syscall("artifact_bundle",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}},get:async n=>{try{return await syscall("artifact_get",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var M={bytes:async n=>{try{return await syscall("blob_bytes",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}},new:async n=>{try{return await syscall("blob_new",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}},text:async n=>{try{return await syscall("blob_text",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},G={new:async(n,e,t)=>{try{return await syscall("call_new",n,e,t)}catch(s){throw new Error("The syscall failed.",{cause:s})}}};var Z={new:async(n,e,t,s)=>{try{return await syscall("download_new",n,e,t,s)}catch(r){throw new Error("The syscall failed.",{cause:r})}}},J={new:async n=>{try{return await syscall("directory_new",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},Q={new:async(n,e,t)=>{try{return await syscall("file_new",n,e,t)}catch(s){throw new Error("The syscall failed.",{cause:s})}}};var X=async(n,e)=>{try{return await syscall("include",n,e)}catch(t){throw new Error("The syscall failed.",{cause:t})}};var Y=n=>{try{return syscall("log",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}},j={get:async n=>{try{return await syscall("operation_get",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}},run:async n=>{try{return await syscall("operation_run",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},ee={new:async(n,e,t,s,r,a,l,m)=>{try{return await syscall("process_new",n,e,t,s,r,a,l,m)}catch(b){throw new Error("The syscall failed.",{cause:b})}}},_=n=>{try{return syscall("stack_frame",n+1)}catch(e){throw new Error("The syscall failed.",{cause:e})}},te={new:async n=>{try{return await syscall("symlink_new",n)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var y=class{#e;#t;#r;#s;static async new(e){let t=await g(e),s,r,a;if(p.Arg.is(t))s=await I(t),r=!1,a=[];else{if(y.is(t))return t;s=await I(t.blob),r=t.executable??!1,a=t.references??[]}return y.fromSyscall(await Q.new(s.toSyscall(),r,a.map(l=>i.toSyscall(l))))}constructor(e){this.#e=e.hash,this.#t=e.blob,this.#r=e.executable,this.#s=e.references}static is(e){return e instanceof y}toSyscall(){return{hash:this.#e,blob:this.#t.toSyscall(),executable:this.#r,references:this.#s}}static fromSyscall(e){return new y({hash:e.hash,blob:p.fromSyscall(e.blob),executable:e.executable,references:e.references})}hash(){return this.#e}blob(){return this.#t}executable(){return this.#r}async references(){return await Promise.all(this.#s.map(i.get))}async bytes(){return await this.blob().bytes()}async text(){return await this.blob().text()}},N=y.new;var u=class{#e;static new(...e){let t=[],s=a=>{if(typeof a=="string")for(let l of a.split("/"))l===""||l==="."||(l===".."?t.push({kind:"parent"}):t.push({kind:"normal",value:l}));else if(u.Component.is(a))t.push(a);else if(a instanceof u)t.push(...a.components());else if(a instanceof Array)for(let l of a)s(l)};for(let a of e)s(a);let r=new u;for(let a of t)r.push(a);return r}constructor(e=[]){this.#e=e}static is(e){return e instanceof u}toSyscall(){return this.toString()}static fromSyscall(e){return w(e)}components(){return[...this.#e]}push(e){if(e.kind==="parent"){let t=this.#e.at(-1);t===void 0||t.kind==="parent"?this.#e.push(e):this.#e.pop()}else this.#e.push(e)}join(e){let t=w(this);for(let s of w(e).components())t.push(s);return t}diff(e){let t=w(e),s=w(this);for(;;){let a=t.#e.at(0),l=s.#e.at(0);if(a&&l&&u.Component.equal(a,l))t.#e.shift(),s.#e.shift();else break}if(t.#e.at(0)?.kind==="parent")throw new Error(`There is no valid path from "${t}" to "${s}".`);return w(Array.from({length:t.#e.length},()=>({kind:"parent"})),s)}toString(){return this.#e.map(e=>{switch(e.kind){case"parent":return"..";case"normal":return e.value}}).join("/")}};(e=>{let n;(r=>(r.is=a=>typeof a=="object"&&a!==null&&"kind"in a&&(a.kind==="parent"||a.kind==="normal"),r.equal=(a,l)=>a.kind===l.kind&&(a.kind==="normal"&&l.kind==="normal"?a.value===l.value:!0)))(n=e.Component||={})})(u||={});(e=>{let n;(s=>s.is=r=>typeof r=="string"||e.Component.is(r)||r instanceof e||r instanceof Array&&r.every(e.Arg.is))(n=e.Arg||={})})(u||={});var w=u.new;var h=class{#e;static new(e){return new h(e)}constructor(e){this.#e=e}static is(e){return e instanceof h}toSyscall(){return{name:this.#e}}static fromSyscall(e){let t=e.name;return new h(t)}name(){return this.#e}},$=h.new;var U=async(n,...e)=>{let t=[];for(let s=0;s<n.length-1;s++){let r=n[s];t.push(r);let a=e[s];t.push(a)}return t.push(n[n.length-1]),await V(...t)},o=class{#e;static async new(...e){let t=[],s=a=>{if(o.Component.is(a))t.push(a);else if(a instanceof u)t.push(a.toString());else if(a instanceof o)t.push(...a.components());else if(a instanceof Array)for(let l of a)s(l)};for(let a of await Promise.all(e.map(g)))s(a);let r=[];for(let a of t){let l=r.at(-1);a!==""&&(typeof l=="string"&&typeof a=="string"?r.splice(-1,1,l+a):r.push(a))}return t=r,new o(t)}constructor(e){this.#e=e}static is(e){return e instanceof o}static async join(e,...t){let s=await V(e),r=await Promise.all(t.map(l=>V(l)));r=r.filter(l=>l.components().length>0);let a=[];for(let l=0;l<r.length;l++){l>0&&a.push(s);let m=r[l];A(m),a.push(m)}return V(...a)}toSyscall(){return{components:this.#e.map(t=>o.Component.toSyscall(t))}}static fromSyscall(e){let t=e.components.map(s=>o.Component.fromSyscall(s));return new o(t)}components(){return[...this.#e]}};(e=>{let n;(a=>(a.is=l=>typeof l=="string"||i.is(l)||l instanceof h,a.toSyscall=l=>typeof l=="string"?{kind:"string",value:l}:i.is(l)?{kind:"artifact",value:i.toSyscall(l)}:l instanceof h?{kind:"placeholder",value:l.toSyscall()}:k(),a.fromSyscall=l=>{switch(l.kind){case"string":return l.value;case"artifact":return i.fromSyscall(l.value);case"placeholder":return h.fromSyscall(l.value);default:return k()}}))(n=e.Component||={})})(o||={});(e=>{let n;(s=>s.is=r=>e.Component.is(r)||r instanceof u||r instanceof e||r instanceof Array&&r.every(e.Arg.is))(n=e.Arg||={})})(o||={});var V=o.new;var f=class{#e;#t;static async new(e){let t=await g(e),s,r;if(typeof t=="string")r=t;else if(u.is(t))r=t.toString();else if(i.is(t))s=t;else if(t instanceof o){A(t.components().length<=2);let[l,m]=t.components();if(typeof l=="string"&&m===void 0)r=l;else if(i.is(l)&&m===void 0)s=l;else if(i.is(l)&&typeof m=="string")s=l,A(m.startsWith("/")),r=m.slice(1);else throw new Error("Invalid template.")}else{if(t instanceof f)return t;if(typeof t=="object"){s=t.artifact;let l=t.path;typeof l=="string"?r=l:u.is(l)&&(r=l.toString())}}let a;return s!==void 0&&r!==void 0?a=await U`${s}/${r}`:s!==void 0&&r===void 0?a=await U`${s}`:s===void 0&&r!==void 0?a=await U`${r}`:a=await U``,f.fromSyscall(await te.new(a.toSyscall()))}constructor(e){this.#e=e.hash,this.#t=e.target}static is(e){return e instanceof f}toSyscall(){let e=this.#e,t=this.#t.toSyscall();return{hash:e,target:t}}static fromSyscall(e){let t=e.hash,s=o.fromSyscall(e.target);return new f({hash:t,target:s})}hash(){return this.#e}target(){return this.#t}artifact(){let e=this.#t.components().at(0);if(i.is(e))return e}path(){let[e,t]=this.#t.components();if(typeof e=="string"&&t===void 0)return w(e);if(i.is(e)&&t===void 0)return w();if(i.is(e)&&typeof t=="string")return w(t);throw new Error("Invalid template.")}async resolve(){let e=this;for(;f.is(e);){let t=e.artifact(),s=e.path();if(c.is(t))e=await t.get(s);else if(y.is(t))A(s.components().length===0),e=t;else if(f.is(t))A(s.components().length===0),e=t;else throw new Error("Cannot resolve a symlink without an artifact in its target.")}return e}},re=f.new;var g=async n=>{if(n=await n,n==null||typeof n=="boolean"||typeof n=="number"||typeof n=="string"||n instanceof Uint8Array||n instanceof u||n instanceof p||n instanceof c||n instanceof y||n instanceof f||n instanceof h||n instanceof o)return n;if(n instanceof Array)return await Promise.all(n.map(e=>g(e)));if(typeof n=="object")return Object.fromEntries(await Promise.all(Object.entries(n).map(async([e,t])=>[e,await g(t)])));throw new Error("Invalid value to resolve.")};var p=class{#e;static async new(e){let t=await g(e),s;if(t instanceof Uint8Array||typeof t=="string")s=t;else return t;return p.fromSyscall(await M.new(s))}constructor(e){this.#e=e.hash}static is(e){return e instanceof p}toSyscall(){return{hash:this.#e}}static fromSyscall(e){let t=e.hash;return new p({hash:t})}hash(){return this.#e}async bytes(){return await M.bytes(this.toSyscall())}async text(){return await M.text(this.toSyscall())}};(e=>{let n;(s=>s.is=r=>r instanceof Uint8Array||typeof r=="string"||r instanceof e)(n=e.Arg||={})})(p||={});var I=p.new;var d;(s=>(s.is=r=>r==null||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Uint8Array||r instanceof u||r instanceof p||r instanceof c||r instanceof y||r instanceof f||r instanceof h||r instanceof o||r instanceof Array||typeof r=="object",s.toSyscall=r=>r==null?{kind:"null",value:r}:typeof r=="boolean"?{kind:"bool",value:r}:typeof r=="number"?{kind:"number",value:r}:typeof r=="string"?{kind:"string",value:r}:r instanceof Uint8Array?{kind:"bytes",value:r}:r instanceof u?{kind:"path",value:r.toSyscall()}:r instanceof p?{kind:"blob",value:r.toSyscall()}:i.is(r)?{kind:"artifact",value:i.toSyscall(r)}:r instanceof h?{kind:"placeholder",value:r.toSyscall()}:r instanceof o?{kind:"template",value:r.toSyscall()}:r instanceof Array?{kind:"array",value:r.map(l=>s.toSyscall(l))}:typeof r=="object"?{kind:"object",value:Object.fromEntries(Object.entries(r).map(([l,m])=>[l,s.toSyscall(m)]))}:k(),s.fromSyscall=r=>{switch(r.kind){case"null":return r.value;case"bool":return r.value;case"number":return r.value;case"string":return r.value;case"bytes":return r.value;case"path":return u.fromSyscall(r.value);case"blob":return p.fromSyscall(r.value);case"artifact":return i.fromSyscall(r.value);case"placeholder":return h.fromSyscall(r.value);case"template":return o.fromSyscall(r.value);case"array":return r.value.map(a=>s.fromSyscall(a));case"object":return Object.fromEntries(Object.entries(r.value).map(([a,l])=>[a,s.fromSyscall(l)]));default:return k()}}))(d||={});var R;(e=>e.is=t=>t==null)(R||={});var c=class{#e;#t;static async new(...e){let t=new Map;for(let s of await Promise.all(e.map(g)))if(!R.is(s)){if(s instanceof c)for(let[r,a]of await s.entries()){let l=t.get(r);l instanceof c&&a instanceof c&&(a=await c.new(l,a)),t.set(r,a)}else if(typeof s=="object")for(let[r,a]of Object.entries(s)){let[l,...m]=w(r).components();if(l===void 0)throw new Error("The path must have at least one component.");if(l.kind!=="normal")throw new Error("Invalid path component.");let b=l.value,v=t.get(b);if(v instanceof c||(v=void 0),m.length>0){let x=w(m).toString(),H=await c.new(v,{[x]:a});t.set(b,H)}else if(R.is(a))t.delete(b);else if(p.Arg.is(a)){let x=await N(a);t.set(b,x)}else if(y.is(a)||f.is(a))t.set(b,a);else{let x=await c.new(v,a);t.set(b,x)}}}return c.fromSyscall(await J.new(new Map(Array.from(t,([s,r])=>[s,i.toSyscall(r)]))))}constructor(e){this.#e=e.hash,this.#t=e.entries}static is(e){return e instanceof c}toSyscall(){return{hash:this.#e,entries:Object.fromEntries(this.#t)}}static fromSyscall(e){let t=e.hash,s=new Map(Object.entries(e.entries));return new c({hash:t,entries:s})}hash(){return this.#e}async get(e){let t=await this.tryGet(e);return A(t,`Failed to get the directory entry "${e}".`),t}async tryGet(e){let t=this;for(let s of w(e).components()){if(A(s.kind==="normal"),!(t instanceof c))return;let r=t.#t.get(s.value);if(!r)return;t=await i.get(r)}return t}async entries(){let e=new Map;for await(let[t,s]of this)e.set(t,s);return e}async bundle(){let e=i.fromSyscall(await B.bundle(i.toSyscall(this)));return A(c.is(e)),e}async*walk(){for await(let[e,t]of this)if(yield[w(e),t],c.is(t))for await(let[s,r]of t.walk())yield[w(e).join(s),r]}*[Symbol.iterator](){for(let[e,t]of this.#t)yield[e,t]}async*[Symbol.asyncIterator](){for(let e of this.#t.keys())yield[e,await this.get(e)]}},se=c.new;var i;(r=>(r.is=a=>a instanceof c||a instanceof y||a instanceof f,r.get=async a=>r.fromSyscall(await B.get(a)),r.toSyscall=a=>a instanceof c?{kind:"directory",value:a.toSyscall()}:a instanceof y?{kind:"file",value:a.toSyscall()}:a instanceof f?{kind:"symlink",value:a.toSyscall()}:k(),r.fromSyscall=a=>{switch(a.kind){case"directory":return c.fromSyscall(a.value);case"file":return y.fromSyscall(a.value);case"symlink":return f.fromSyscall(a.value);default:return k()}}))(i||={});var D=new Map;var S=class extends globalThis.Function{packageInstanceHash;name;f;static new(e){let{module:t,line:s}=_(1);A(t.kind==="normal");let r=t.value.packageInstanceHash,a;if(s.startsWith("export default "))a="default";else if(s.startsWith("export let ")){let l=s.match(/^export let ([a-zA-Z0-9]+)\b/)?.at(1);if(!l)throw new Error("Invalid use of tg.function.");a=l}else throw new Error("Invalid use of tg.function.");return new S({packageInstanceHash:r,name:a,f:e})}constructor(e){return super(),this.packageInstanceHash=e.packageInstanceHash,this.name=e.name,this.f=e.f,new Proxy(this,{apply:async(t,s,r)=>{let a=await Promise.all(r.map(g));return await z({function:t,args:a})}})}static is(e){return e instanceof S}toSyscall(){let e=this.packageInstanceHash,t=this.name?.toString();return{packageInstanceHash:e,name:t}}static fromSyscall(e){let t=e.packageInstanceHash,s=e.name;return new S({packageInstanceHash:t,name:s})}async run(e,t){for(let[a,l]of Object.entries(e))D.set(a,d.fromSyscall(l));let s=t.map(d.fromSyscall);A(this.f);let r=await this.f(...s);return d.toSyscall(r)}},ae=S.new;var ne=async n=>await(await T.new(n)).run(),T=class{#e;#t;#r;#s;#a;static async new(e){return T.fromSyscall(await Z.new(e.url,e.unpack??!1,e.checksum??null,e.unsafe??!1))}constructor(e){this.#e=e.hash,this.#t=e.url,this.#r=e.unpack??!1,this.#s=e.checksum??null,this.#a=e.unsafe??!1}static is(e){return e instanceof T}hash(){return this.#e}toSyscall(){return{hash:this.#e,url:this.#t,unpack:this.#r,checksum:this.#s,unsafe:this.#a}}static fromSyscall(e){return new T({hash:e.hash,url:e.url,unpack:e.unpack,checksum:e.checksum,unsafe:e.unsafe})}async run(){let e=await j.run(E.toSyscall(this));return d.fromSyscall(e)}};var le=$("output"),O=class{#e;#t;#r;#s;#a;#n;#l;#o;#i;static async new(e){let t=await g(e),s=t.system,r=await V(t.executable),a=Object.fromEntries(await Promise.all(Object.entries(t.env??{}).map(async([F,me])=>[F,await V(me)]))),l=await Promise.all((t.args??[]).map(async F=>await V(F))),m=t.checksum??null,b=t.unsafe??!1,v=t.network??!1,x=t.hostPaths??[];return await O.fromSyscall(await ee.new(s,r.toSyscall(),a,l.map(F=>F.toSyscall()),m,b,v,x)).run()}constructor(e){this.#e=e.hash,this.#t=e.system,this.#r=e.executable,this.#s=e.env,this.#a=e.args,this.#n=e.checksum,this.#l=e.unsafe,this.#o=e.network,this.#i=e.hostPaths}hash(){return this.#e}toSyscall(){let e=this.#e,t=this.#t,s=this.#r.toSyscall(),r=Object.fromEntries(Object.entries(this.#s).map(([x,H])=>[x,H.toSyscall()])),a=this.#a.map(x=>x.toSyscall()),l=this.#n,m=this.#l,b=this.#o,v=this.#i;return{hash:e,system:t,executable:s,env:r,args:a,checksum:l,unsafe:m,network:b,hostPaths:v}}static fromSyscall(e){let t=e.hash,s=e.system,r=o.fromSyscall(e.executable),a=Object.fromEntries(Object.entries(e.env).map(([H,q])=>[H,o.fromSyscall(q)])),l=e.args.map(H=>o.fromSyscall(H)),m=e.checksum,b=e.unsafe,v=e.network,x=e.hostPaths;return new O({hash:t,system:s,executable:r,env:a,args:l,checksum:m,unsafe:b,network:v,hostPaths:x})}async run(){let e=await j.run(E.toSyscall(this));return d.fromSyscall(e)}},oe=O.new;var E;(s=>(s.is=r=>r instanceof C||r instanceof T||r instanceof O,s.toSyscall=r=>r instanceof T?{kind:"download",value:r.toSyscall()}:r instanceof O?{kind:"process",value:r.toSyscall()}:r instanceof C?{kind:"call",value:r.toSyscall()}:k(),s.fromSyscall=(r,a)=>{switch(a.kind){case"download":return T.fromSyscall(a.value);case"process":return O.fromSyscall(a.value);case"call":return C.fromSyscall(a.value);default:return k()}}))(E||={});var z=async n=>await(await C.new(n)).run(),C=class{#e;#t;#r;#s;static async new(e){let t=e.function.toSyscall(),s=Object.fromEntries(Object.entries(e.env??{}).map(([l,m])=>[l,d.toSyscall(m)])),r=(e.args??[]).map(l=>d.toSyscall(l));return C.fromSyscall(await G.new(t,s,r))}constructor(e){this.#e=e.hash,this.#t=e.function,this.#r=e.env,this.#s=e.args}static is(e){return e instanceof C}hash(){return this.#e}toSyscall(){let e=this.#e,t=this.#t.toSyscall(),s=Object.fromEntries(Array.from(this.#r.entries()).map(([a,l])=>[a,d.toSyscall(l)])),r=this.#s.map(a=>d.toSyscall(a));return{hash:e,function:t,env:s,args:r}}static fromSyscall(e){let t=e.hash,s=S.fromSyscall(e.function),r=new Map(Object.entries(e.env).map(([l,m])=>[l,d.fromSyscall(m)])),a=e.args.map(l=>d.fromSyscall(l));return new C({hash:t,function:s,env:r,args:a})}async run(){let e=await j.run(E.toSyscall(this));return d.fromSyscall(e)}};function ie(n,e){return{callSites:e.map(s=>({typeName:s.getTypeName(),functionName:s.getFunctionName(),methodName:s.getMethodName(),fileName:s.getFileName(),lineNumber:s.getLineNumber(),columnNumber:s.getColumnNumber(),isEval:s.isEval(),isNative:s.isNative(),isConstructor:s.isConstructor(),isAsync:s.isAsync(),isPromiseAll:s.isPromiseAll(),promiseIndex:s.getPromiseIndex()}))}}var ce=async n=>{let e=_(1);return i.fromSyscall(await X(e,n))};var L=(...n)=>{let e=n.map(t=>ye(t)).join(" ");Y(e)},ye=n=>K(n,new Set),K=(n,e)=>{switch(typeof n){case"string":return`"${n}"`;case"number":return n.toString();case"boolean":return n?"true":"false";case"undefined":return"undefined";case"object":return pe(n,e);case"function":return`[function ${n.name??"(anonymous)"}]`;case"symbol":return"[symbol]";case"bigint":return n.toString()}},pe=(n,e)=>{if(n===null)return"null";if(e.has(n))return"[circular]";if(e.add(n),n instanceof Array)return`[${n.map(t=>K(t,e)).join(", ")}]`;if(n instanceof Error)return n.stack??"";if(n instanceof Promise)return"[promise]";{let t="";n.constructor!==void 0&&n.constructor.name!=="Object"&&(t=`${n.constructor.name} `);let s=Object.entries(n).map(([r,a])=>`${r}: ${K(a,e)}`);return`${t}{ ${s.join(", ")} }`}};var ue=n=>{if(typeof n=="string")return n;{let{arch:e,os:t}=n;return`${e}_${t}`}},W;(t=>(t.arch=s=>{switch(s){case"amd64_linux":case"amd64_macos":return"amd64";case"arm64_linux":case"arm64_macos":return"arm64";default:throw new Error("Invalid system.")}},t.os=s=>{switch(s){case"amd64_linux":case"arm64_linux":return"linux";case"amd64_macos":case"arm64_macos":return"macos";default:throw new Error("Invalid system.")}}))(W||={});Object.defineProperties(Error,{prepareStackTrace:{value:ie}});var fe={log:L};Object.defineProperties(globalThis,{console:{value:fe}});var he={Artifact:i,Blob:p,Directory:c,File:y,Function:S,Path:u,Placeholder:h,Symlink:f,System:W,Template:o,Value:d,blob:I,call:z,directory:se,download:ne,env:D,file:N,function:ae,include:ce,log:L,nullish:R,output:le,path:w,placeholder:$,process:oe,resolve:g,symlink:re,system:ue,template:V};Object.defineProperties(globalThis,{tg:{value:he},t:{value:U}});})();
//# sourceMappingURL=global.js.map
