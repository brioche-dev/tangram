"use strict";(()=>{var Be=Object.defineProperty;var Re=(t,e)=>{for(var s in e)Be(t,s,{get:e[s],enumerable:!0})};var c=(t,e)=>{if(!t)throw new Error(e??"Failed assertion.")},se=t=>{throw new Error(t??"Reached unimplemented code.")},p=t=>{throw new Error(t??"Reached unreachable code.")};var W={};Re(W,{base64:()=>ue,hex:()=>me,json:()=>L,toml:()=>ye,utf8:()=>I,yaml:()=>pe});var G={bundle:async t=>{try{return await syscall("artifact_bundle",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},get:async t=>{try{return await syscall("artifact_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},z={bytes:async t=>{try{return await syscall("blob_bytes",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},get:async t=>{try{return await syscall("blob_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},new:async t=>{try{return await syscall("blob_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},text:async t=>{try{return await syscall("blob_text",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},K={bytes:async t=>{try{return await syscall("block_bytes",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},children:async t=>{try{return syscall("block_children",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},data:async t=>{try{return await syscall("block_data",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},new:async t=>{try{return syscall("block_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var ne={new:async t=>{try{return await syscall("directory_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},R;(r=>(r.base64={decode:l=>{try{return syscall("encoding_base64_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_base64_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.hex={decode:l=>{try{return syscall("encoding_hex_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_hex_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.json={decode:l=>{try{return syscall("encoding_json_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_json_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.toml={decode:l=>{try{return syscall("encoding_toml_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_toml_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.utf8={decode:l=>{try{return syscall("encoding_utf8_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_utf8_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}},r.yaml={decode:l=>{try{return syscall("encoding_yaml_decode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}},encode:l=>{try{return syscall("encoding_yaml_encode",l)}catch(i){throw new Error("The syscall failed.",{cause:i})}}}))(R||={});var ae={new:async t=>{try{return await syscall("file_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},oe=t=>{try{return syscall("log",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},N={get:async t=>{try{return await syscall("operation_get",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}},evaluation:async t=>{try{return await syscall("operation_evaluate",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},le={new:async t=>{try{return await syscall("resource_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},Z={new:async t=>{try{return await syscall("target_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},ie={new:async t=>{try{return await syscall("task_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}},ce={new:async t=>{try{return await syscall("symlink_new",t)}catch(e){throw new Error("The syscall failed.",{cause:e})}}};var ue;(s=>(s.decode=n=>R.base64.decode(n),s.encode=n=>R.base64.encode(n)))(ue||={});var me;(s=>(s.decode=n=>R.hex.decode(n),s.encode=n=>R.hex.encode(n)))(me||={});var L;(s=>(s.decode=n=>R.json.decode(n),s.encode=n=>R.json.encode(n)))(L||={});var ye;(s=>(s.decode=n=>R.toml.decode(n),s.encode=n=>R.toml.encode(n)))(ye||={});var I;(s=>(s.decode=n=>R.utf8.decode(n),s.encode=n=>R.utf8.encode(n)))(I||={});var pe;(s=>(s.decode=n=>R.yaml.decode(n),s.encode=n=>R.yaml.encode(n)))(pe||={});var _=t=>t.flat(1/0);var q=async(...t)=>await x.new(...t),x=class t{#e;#t;#r;#s;static async new(...e){let{contents:s,executable:n,references:a}=_(await Promise.all(e.map(async function r(l){let i=await k(l);return h.Arg.is(i)?{contents:i}:t.is(i)?{contents:i.#t,executable:i.#r,references:await i.references()}:i instanceof Array?await Promise.all(i.map(r)):i instanceof Object?{contents:i.contents,executable:i.executable,references:i.references}:p()}))).reduce((r,{contents:l,executable:i,references:u})=>(r.contents.push(l),r.executable=i!==void 0?i:r.executable,r.references.push(...u??[]),r),{contents:[],executable:!1,references:[]}),o=await H(...s);return t.fromSyscall(await ae.new({contents:o.toSyscall(),executable:n,references:a.map(r=>y.toSyscall(r))}))}constructor(e){this.#e=e.block,this.#t=e.contents,this.#r=e.executable,this.#s=e.references}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=this.#t.toSyscall(),n=this.#r,a=this.#s.map(o=>o.toSyscall());return{block:e,contents:s,executable:n,references:a}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=m.fromSyscall(e.contents),a=e.executable,o=e.references.map(r=>m.fromSyscall(r));return new t({block:s,contents:n,executable:a,references:o})}id(){return this.block().id()}block(){return this.#e}async contents(){return await h.withBlock(this.#t)}executable(){return this.#r}async references(){return await Promise.all(this.#s.map(y.get))}async bytes(){return await(await this.contents()).bytes()}async text(){return await(await this.contents()).text()}};var U=(...t)=>d.new(...t),j=(...t)=>b.new(...t),d=class t{#e;#t;static new(...e){return e.reduce(function s(n,a){if(typeof a=="string")for(let o of a.split("/"))o===""||o==="."||(o===".."?n=n.parent():n.#t.push(o));else if(a instanceof t){for(let o=0;o<a.#e;o++)n.parent();n.#t.join(a.#t)}else if(a instanceof b)n.#t.join(a);else if(a instanceof Array)a.forEach(o=>s(n,o));else return p();return n},new t)}constructor(e){this.#e=e?.parents??0,this.#t=e?.subpath??new b}static is(e){return e instanceof t}toSyscall(){return this.toString()}static fromSyscall(e){return t.new(e)}isEmpty(){return this.#e==0&&this.#t.isEmpty()}parents(){return this.#e}subpath(){return this.#t}parent(){return this.#t.isEmpty()?this.#e+=1:this.#t.pop(),this}join(e){e=t.new(e);for(let s=0;s<e.#e;s++)this.parent();return this.#t.join(e.#t),this}extension(){return this.#t.extension()}toSubpath(){if(this.#e>0)throw new Error("Cannot convert to subpath.");return this.#t}toString(){let e="";for(let s=0;s<this.#e;s++)e+="../";return e+=this.#t.toString(),e}};(e=>{let t;(o=>(o.is=r=>r===void 0||typeof r=="string"||r instanceof b||r instanceof e||r instanceof Array&&r.every(e.Arg.is),o.expect=r=>(c((0,o.is)(r)),r),o.assert=r=>{c((0,o.is)(r))}))(t=e.Arg||={})})(d||={});var b=class t{#e;static new(...e){return d.new(...e).toSubpath()}constructor(e){this.#e=e??[]}static is(e){return e instanceof t}toSyscall(){return this.toString()}static fromSyscall(e){return j(e)}components(){return[...this.#e]}isEmpty(){return this.#e.length==0}join(e){return this.#e.push(...e.#e),this}push(e){this.#e.push(e)}pop(){this.#e.pop()}extension(){return this.#e.at(-1)?.split(".").at(-1)}toRelpath(){return d.new(this)}toString(){return this.#e.join("/")}};var J=t=>S.new(t),S=class t{#e;static new(e){return new t(e)}constructor(e){this.#e=e}static is(e){return e instanceof t}toSyscall(){return{name:this.#e}}static fromSyscall(e){let s=e.name;return new t(s)}name(){return this.#e}};var D;(s=>s.get=()=>(c(s.value),s.value))(D||={});var M=async(t,...e)=>{let s=[];for(let n=0;n<t.length-1;n++){let a=t[n];s.push(a);let o=e[n];s.push(o)}return s.push(t[t.length-1]),await F(...s)},F=(...t)=>f.new(...t),f=class t{#e;static async new(...e){let s=_(await Promise.all(e.map(async function n(a){return a=await k(a),t.Component.is(a)?a:a instanceof d||a instanceof b?a.toString():a instanceof t?a.components():a instanceof Array?await Promise.all(a.map(n)):p()}))).reduce((n,a)=>(n.push(a),n),[]);return s=s.reduce((n,a)=>{let o=n.at(-1);return a===""||(typeof o=="string"&&typeof a=="string"?n.splice(-1,1,o+a):n.push(a)),n},[]),new t(s)}constructor(e){this.#e=e}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}static async join(e,...s){let n=await F(e),a=await Promise.all(s.map(r=>F(r)));a=a.filter(r=>r.components().length>0);let o=[];for(let r=0;r<a.length;r++){r>0&&o.push(n);let l=a[r];c(l),o.push(l)}return F(...o)}toSyscall(){return{components:this.#e.map(s=>t.Component.toSyscall(s))}}static fromSyscall(e){let s=e.components.map(n=>t.Component.fromSyscall(n));return new t(s)}components(){return[...this.#e]}};(e=>{let t;(o=>(o.is=r=>typeof r=="string"||y.is(r)||r instanceof S,o.toSyscall=r=>typeof r=="string"?{kind:"string",value:r}:y.is(r)?{kind:"artifact",value:y.toSyscall(r)}:r instanceof S?{kind:"placeholder",value:r.toSyscall()}:p(),o.fromSyscall=r=>{switch(r.kind){case"string":return r.value;case"artifact":return y.fromSyscall(r.value);case"placeholder":return S.fromSyscall(r.value);default:return p()}}))(t=e.Component||={})})(f||={});var ee=async(...t)=>await A.new(...t),A=class t{#e;#t;static async new(...e){let{artifact:s,path:n}=_(await Promise.all(e.map(async function o(r){let l=await k(r);if(typeof l=="string")return{path:U(l)};if(d.is(l))return{path:U(l)};if(b.is(l))return{path:l.toRelpath()};if(y.is(l))return{artifact:l};if(l instanceof f){c(l.components().length<=2);let[i,u]=l.components();if(typeof i=="string"&&u===void 0)return{path:U(i)};if(y.is(i)&&u===void 0)return{artifact:i};if(y.is(i)&&typeof u=="string")return c(u.startsWith("/")),{artifact:i,path:U(u.slice(1))};throw new Error("Invalid template.")}else return l instanceof t?{artifact:l.artifact(),path:l.path()}:l instanceof Array?await Promise.all(l.map(o)):typeof l=="object"?{artifact:l.artifact,path:U(l.path)}:p()}))).reduce((o,{artifact:r,path:l})=>(r!==void 0?(o.artifact=r,o.path=l??U()):o.path=o.path.join(l),o),{artifact:void 0,path:U()}),a;if(s!==void 0&&!n.isEmpty())a=await M`${s}/${n}`;else if(s!==void 0)a=await M`${s}`;else if(!n.isEmpty())a=await M`${n}`;else throw new Error("Invalid symlink.");return t.fromSyscall(await ce.new({target:a.toSyscall()}))}constructor(e){this.#e=e.block,this.#t=e.target}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=this.#t.toSyscall();return{block:e,target:s}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=f.fromSyscall(e.target);return new t({block:s,target:n})}id(){return this.block().id()}block(){return this.#e}target(){return this.#t}artifact(){let e=this.#t.components().at(0);if(y.is(e))return e}path(){let[e,s]=this.#t.components();if(typeof e=="string"&&s===void 0)return U(e);if(y.is(e)&&s===void 0)return U();if(y.is(e)&&typeof s=="string")return U(s.slice(1));throw new Error("Invalid template.")}async resolve(e){e=e?await ee(e):void 0;let s=e?.artifact();s instanceof t&&(s=await s.resolve());let n=e?.path(),a=this.artifact();a instanceof t&&(a=await a.resolve());let o=this.path();if(a!==void 0&&o.isEmpty())return a;if(a===void 0&&!o.isEmpty()){if(!(s instanceof g))throw new Error("Expected a directory.");return await s.tryGet((n??U()).parent().join(o).toSubpath())}else if(a!==void 0&&!o.isEmpty()){if(!(a instanceof g))throw new Error("Expected a directory.");return await a.tryGet(o.toSubpath())}else throw new Error("Invalid symlink.")}};var fe=async t=>await P.new(t),de=async t=>await(await P.new(t)).run(),he=J("output"),P=class t{#e;#t;#r;#s;#n;#a;#o;#l;static async new(e){let s=await k(e),n=s.system,a=await F(s.executable),o=Object.fromEntries(await Promise.all(Object.entries(s.env??{}).map(async([T,C])=>[T,await F(C)]))),r=Object.fromEntries(Object.entries(o).map(([T,C])=>[T,C.toSyscall()])),l=await Promise.all((s.args??[]).map(async T=>(await F(T)).toSyscall())),i=s.checksum??void 0,u=s.unsafe??!1,O=s.network??!1;return t.fromSyscall(await ie.new({system:n,executable:a.toSyscall(),env:r,args:l,checksum:i,unsafe:u,network:O}))}constructor(e){this.#e=e.block,this.#t=e.system,this.#r=e.executable,this.#s=e.env,this.#n=e.args,this.#a=e.checksum,this.#o=e.unsafe,this.#l=e.network}toSyscall(){let e=this.#e.toSyscall(),s=this.#t,n=this.#r.toSyscall(),a=Object.fromEntries(Object.entries(this.#s).map(([u,O])=>[u,O.toSyscall()])),o=this.#n.map(u=>u.toSyscall()),r=this.#a,l=this.#o,i=this.#l;return{block:e,system:s,executable:n,env:a,args:o,checksum:r,unsafe:l,network:i}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=e.system,a=f.fromSyscall(e.executable),o=Object.fromEntries(Object.entries(e.env).map(([O,T])=>[O,f.fromSyscall(T)])),r=e.args.map(O=>f.fromSyscall(O)),l=e.checksum,i=e.unsafe,u=e.network;return new t({block:s,system:n,executable:a,env:o,args:r,checksum:l,unsafe:i,network:u})}id(){return this.block().id()}block(){return this.#e}async run(){let e=await N.evaluation(V.toSyscall(this));return w.fromSyscall(e)}};var w;(o=>(o.is=r=>r===void 0||typeof r=="boolean"||typeof r=="number"||typeof r=="string"||r instanceof Uint8Array||r instanceof d||r instanceof b||r instanceof h||r instanceof m||r instanceof g||r instanceof x||r instanceof A||r instanceof S||r instanceof f||r instanceof E||r instanceof B||r instanceof P||r instanceof Array||typeof r=="object",o.expect=r=>(c((0,o.is)(r)),r),o.assert=r=>{c((0,o.is)(r))},o.toSyscall=r=>r===void 0?{kind:"null"}:typeof r=="boolean"?{kind:"bool",value:r}:typeof r=="number"?{kind:"number",value:r}:typeof r=="string"?{kind:"string",value:r}:r instanceof Uint8Array?{kind:"bytes",value:r}:r instanceof d?{kind:"relpath",value:r.toSyscall()}:r instanceof b?{kind:"subpath",value:r.toSyscall()}:r instanceof m?{kind:"block",value:r.toSyscall()}:r instanceof h?{kind:"blob",value:r.toSyscall()}:y.is(r)?{kind:"artifact",value:y.toSyscall(r)}:r instanceof S?{kind:"placeholder",value:r.toSyscall()}:r instanceof f?{kind:"template",value:r.toSyscall()}:V.is(r)?{kind:"operation",value:V.toSyscall(r)}:r instanceof Array?{kind:"array",value:r.map(i=>o.toSyscall(i))}:typeof r=="object"?{kind:"object",value:Object.fromEntries(Object.entries(r).map(([i,u])=>[i,o.toSyscall(u)]))}:p(),o.fromSyscall=r=>{switch(r.kind){case"null":return;case"bool":return r.value;case"number":return r.value;case"string":return r.value;case"bytes":return r.value;case"relpath":return d.fromSyscall(r.value);case"subpath":return b.fromSyscall(r.value);case"block":return m.fromSyscall(r.value);case"blob":return h.fromSyscall(r.value);case"artifact":return y.fromSyscall(r.value);case"placeholder":return S.fromSyscall(r.value);case"template":return f.fromSyscall(r.value);case"operation":return V.fromSyscall(r.value);case"array":return r.value.map(l=>o.fromSyscall(l));case"object":return Object.fromEntries(Object.entries(r.value).map(([l,i])=>[l,o.fromSyscall(i)]));default:return p()}}))(w||={});var Q={},ke=async t=>{c(t.module.kind==="normal");let e=B.fromSyscall(await Z.new({package:t.module.value.package,modulePath:t.module.value.modulePath,name:t.name,env:{},args:[]}));e.f=t.f;let s=L.encode({module:t.module,name:t.name});return c(Q[s]===void 0),Q[s]=e,e},be=async(t,e,s)=>{D.value=Object.fromEntries(Object.entries(e).map(([r,l])=>[r,w.fromSyscall(l)]));let n=s.map(r=>w.fromSyscall(r)),a=await t(...n);return w.toSyscall(a)},B=class t extends globalThis.Function{f;block;package;modulePath;name;env;args;static async new(e){let s=Object.fromEntries(Object.entries(e.env??{}).map(([o,r])=>[o,w.toSyscall(r)])),n=(e.args??[]).map(o=>w.toSyscall(o)),a=t.fromSyscall(await Z.new({package:e.target.package.toSyscall(),modulePath:e.target.modulePath.toSyscall(),name:e.target.name,env:s,args:n}));return a.f=e.target.f,a}constructor(e){return super(),this.f=e.f,this.block=e.block,this.package=e.package,this.modulePath=j(e.modulePath),this.name=e.name,this.env=e.env,this.args=e.args,new Proxy(this,{apply:async(s,n,a)=>{let o=await t.new({target:s,args:await Promise.all(a.map(k)),env:D.value}),r=await N.evaluation(V.toSyscall(o));return w.fromSyscall(r)}})}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.block.toSyscall(),s=this.package.toSyscall(),n=this.modulePath.toString(),a=this.name,o=this.env?Object.fromEntries(Object.entries(this.env).map(([l,i])=>[l,w.toSyscall(i)])):void 0,r=this.args?this.args.map(l=>w.toSyscall(l)):void 0;return{block:e,package:s,modulePath:n,name:a,env:o,args:r}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=m.fromSyscall(e.package),a=e.modulePath,o=e.name,r=e.env!==void 0?Object.fromEntries(Object.entries(e.env).map(([i,u])=>[i,w.fromSyscall(u)])):void 0,l=e.args!==void 0?e.args.map(i=>w.fromSyscall(i)):void 0;return new t({block:s,package:n,modulePath:a,name:o,env:r,args:l})}};var V;(n=>(n.is=a=>a instanceof E||a instanceof B||a instanceof P,n.toSyscall=a=>a instanceof E?{kind:"resource",value:a.toSyscall()}:a instanceof B?{kind:"target",value:a.toSyscall()}:a instanceof P?{kind:"task",value:a.toSyscall()}:p(),n.fromSyscall=a=>{switch(a.kind){case"resource":return E.fromSyscall(a.value);case"target":return B.fromSyscall(a.value);case"task":return P.fromSyscall(a.value);default:return p()}}))(V||={});var ge=async t=>await E.new(t),Ae=async t=>await(await E.new(t)).download(),E=class t{#e;#t;#r;#s;#n;static async new(e){return t.fromSyscall(await le.new({url:e.url,unpack:e.unpack??void 0,checksum:e.checksum??void 0,unsafe:e.unsafe??!1}))}constructor(e){this.#e=e.block,this.#t=e.url,this.#r=e.unpack??void 0,this.#s=e.checksum??void 0,this.#n=e.unsafe??!1}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}id(){return this.block().id()}block(){return this.#e}toSyscall(){return{block:this.#e.toSyscall(),url:this.#t,unpack:this.#r,checksum:this.#s,unsafe:this.#n}}static fromSyscall(e){return new t({block:m.fromSyscall(e.block),url:e.url,unpack:e.unpack,checksum:e.checksum,unsafe:e.unsafe})}async download(){let e=await N.evaluation(V.toSyscall(this));return w.fromSyscall(e)}};var k=async t=>{if(t=await t,t===void 0||typeof t=="boolean"||typeof t=="number"||typeof t=="string"||t instanceof Uint8Array||t instanceof d||t instanceof b||t instanceof h||t instanceof g||t instanceof x||t instanceof A||t instanceof S||t instanceof f||t instanceof E||t instanceof B||t instanceof P)return t;if(t instanceof Array)return await Promise.all(t.map(e=>k(e)));if(typeof t=="object")return Object.fromEntries(await Promise.all(Object.entries(t).map(async([e,s])=>[e,await k(s)])));throw new Error("Invalid value to resolve.")};var X=async(...t)=>await m.new(...t),m=class t{#e;#t;#r;static withId(e){return new t({id:e})}static async new(...e){let{children:s,data:n}=_(await Promise.all(e.map(async function l(i){let u=await k(i);if(u===void 0)return{};if(typeof u=="string")return{data:[I.encode(u)]};if(u instanceof Uint8Array)return{data:[u]};if(u instanceof t)return{children:await u.children(),data:[await u.bytes()]};if(u instanceof Array)return await Promise.all(u.map(l));if(typeof u=="object"){let O=await Promise.all((u.children??[]).map(C=>t.new(C))),T=typeof u.data=="string"?[I.encode(u.data)]:u.data instanceof Uint8Array?[u.data]:[];return{children:O,data:T}}else return p()}))).reduce((l,{children:i,data:u})=>(i!==void 0&&l.children.push(...i),u!==void 0&&l.data.push(...u),l),{children:[],data:[]}),a=n.reduce((l,i)=>l+i.length,0),o=new Uint8Array(a),r=0;for(let l of n)o.set(l,r),r+=l.length;return t.fromSyscall(await K.new({children:s.map(l=>l.toSyscall()),data:o}))}constructor(e){this.#e=e.id,this.#t=e.bytes,this.#r=e.children}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){return console.log(this.#t),{id:this.#e,bytes:this.#t,children:this.#r?Object.fromEntries(Object.entries(this.#r).map(([e,s])=>[e,s.toSyscall()])):void 0}}static fromSyscall(e){let s=e.id,n=e.bytes,a=e.children?Object.fromEntries(Object.entries(e.children).map(([o,r])=>[o,t.fromSyscall(r)])):void 0;return new t({id:s,bytes:n,children:a})}id(){return this.#e}async bytes(){return await K.bytes(this.toSyscall())}async text(){return I.decode(await this.bytes())}async children(){return(await K.children(this.toSyscall())).map(e=>t.fromSyscall(e))}async data(){return await K.data(this.toSyscall())}};(e=>{let t;(o=>(o.is=r=>r===void 0||typeof r=="string"||r instanceof Uint8Array||r instanceof e||r instanceof Array&&r.every(o.is),o.expect=r=>(c((0,o.is)(r)),r),o.assert=r=>{c((0,o.is)(r))}))(t=e.Arg||={})})(m||={});var H=async(...t)=>await h.new(...t),h=class t{#e;#t;static async withBlock(e){return t.fromSyscall(await z.get(e.toSyscall()))}static async new(...e){let s=_(await Promise.all(e.map(async function n(a){let o=await k(a);return m.Arg.is(o)?await X(o):o instanceof t?o.block():o instanceof Array?await Promise.all(o.map(n)):p()}))).reduce((n,a)=>(n.push(a),n),[]);return t.fromSyscall(await z.new({children:s.map(n=>n.toSyscall())}))}constructor(e){this.#e=e.block,this.#t=e.kind}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){return{block:this.#e.toSyscall(),kind:this.#t}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=e.kind;return new t({block:s,kind:n})}id(){return this.block().id()}block(){return this.#e}async bytes(){return await z.bytes(this.toSyscall())}async text(){return await z.text(this.toSyscall())}};(e=>{let t;(o=>(o.is=r=>m.Arg.is(r)||r instanceof e||r instanceof Array&&r.every(o.is),o.expect=r=>(c((0,o.is)(r)),r),o.assert=r=>{c((0,o.is)(r))}))(t=e.Arg||={})})(h||={});var we=async(...t)=>await g.new(...t),g=class t{#e;#t;static async new(...e){let s=await(await Promise.all(e.map(k))).reduce(async function n(a,o){let r=await a;if(o!==void 0)if(o instanceof t)for(let[l,i]of Object.entries(await o.entries())){let u=r[l];u instanceof t&&i instanceof t&&(i=await t.new(u,i)),r[l]=i}else if(o instanceof Array)for(let l of o)r=await n(Promise.resolve(r),l);else if(typeof o=="object")for(let[l,i]of Object.entries(o)){let[u,...O]=j(l).components();if(u===void 0)throw new Error("The path must have at least one component.");let T=u,C=r[T];if(C instanceof t||(C=void 0),O.length>0){let $=j(O).toString(),Pe=await t.new(C,{[$]:i});r[T]=Pe}else if(i===void 0)delete r[T];else if(h.Arg.is(i)){let $=await q(i);r[T]=$}else if(x.is(i)||A.is(i))r[T]=i;else{let $=await t.new(C,i);r[T]=$}}else return p();return r},Promise.resolve({}));return t.fromSyscall(await ne.new({entries:Object.fromEntries(Object.entries(s).map(([n,a])=>[n,y.toSyscall(a)]))}))}constructor(e){this.#e=e.block,this.#t=e.entries}static is(e){return e instanceof t}static expect(e){return c(t.is(e)),e}static assert(e){c(t.is(e))}toSyscall(){let e=this.#e.toSyscall(),s=Object.fromEntries(Object.entries(this.#t).map(([n,a])=>[n,a.toSyscall()]));return{block:e,entries:s}}static fromSyscall(e){let s=m.fromSyscall(e.block),n=Object.fromEntries(Object.entries(e.entries).map(([a,o])=>[a,m.fromSyscall(o)]));return new t({block:s,entries:n})}id(){return this.block().id()}block(){return this.#e}async get(e){let s=await this.tryGet(e);return c(s,`Failed to get the directory entry "${e}".`),s}async tryGet(e){let s=this,n=j();e=j(e);for(let a of e.components()){if(!(s instanceof t))return;n.push(a);let o=s.#t[a];if(o===void 0)return;let r=await y.get(o);if(r instanceof A){let l=await r.resolve({artifact:this,path:n});if(l===void 0)return;s=l}else s=r}return s}async entries(){let e={};for await(let[s,n]of this)e[s]=n;return e}async bundle(){let e=y.fromSyscall(await G.bundle(y.toSyscall(this)));return c(t.is(e)),e}async*walk(){for await(let[e,s]of this)if(yield[j(e),s],t.is(s))for await(let[n,a]of s.walk())yield[j(e).join(n),a]}*[Symbol.iterator](){for(let[e,s]of Object.entries(this.#t))yield[e,s]}async*[Symbol.asyncIterator](){for(let[e,s]of this)yield[e,await y.get(s)]}};var y;(r=>(r.is=l=>l instanceof g||l instanceof x||l instanceof A,r.expect=l=>(c((0,r.is)(l)),l),r.assert=l=>{c((0,r.is)(l))},r.get=async l=>r.fromSyscall(await G.get(l.toSyscall())),r.toSyscall=l=>l instanceof g?{kind:"directory",value:l.toSyscall()}:l instanceof x?{kind:"file",value:l.toSyscall()}:l instanceof A?{kind:"symlink",value:l.toSyscall()}:p(),r.fromSyscall=l=>{switch(l.kind){case"directory":return g.fromSyscall(l.value);case"file":return x.fromSyscall(l.value);case"symlink":return A.fromSyscall(l.value);default:return p()}}))(y||={});var xe=(t,e)=>({callSites:e.map(n=>({typeName:n.getTypeName(),functionName:n.getFunctionName(),methodName:n.getMethodName(),fileName:n.getFileName(),lineNumber:n.getLineNumber(),columnNumber:n.getColumnNumber(),isEval:n.isEval(),isNative:n.isNative(),isConstructor:n.isConstructor(),isAsync:n.isAsync(),isPromiseAll:n.isPromiseAll(),promiseIndex:n.getPromiseIndex()}))});var Se=async t=>{c(t.module.kind==="normal");let e=await y.get(m.fromSyscall(t.module.value.package));g.assert(e);let s=j(t.module.value.modulePath).toRelpath().parent().join(t.path).toSubpath();return e.get(s)};var te=(...t)=>{let e=t.map(s=>Ue(s)).join(" ");oe(e)},Ue=t=>Y(t,new WeakSet),Y=(t,e)=>{switch(typeof t){case"string":return`"${t}"`;case"number":return t.toString();case"boolean":return t?"true":"false";case"undefined":return"undefined";case"object":return t===null?"null":je(t,e);case"function":return`(function "${t.name??"(anonymous)"}")`;case"symbol":return"(symbol)";case"bigint":return t.toString()}},je=(t,e)=>{if(e.has(t))return"(circular)";if(e.add(t),t instanceof Array)return`[${t.map(s=>Y(s,e)).join(", ")}]`;if(t instanceof Error)return t.stack??"";if(t instanceof Promise)return"(promise)";if(t instanceof d)return`(tg.relpath ${t.toString()})`;if(t instanceof b)return`(tg.subpath ${t.toString()})`;if(t instanceof h)return`(tg.blob ${t.id()})`;if(t instanceof m)return`(tg.block ${t.id()})`;if(t instanceof g)return`(tg.directory ${t.id()})`;if(t instanceof x)return`(tg.file ${t.id()})`;if(t instanceof A)return`(tg.symlink ${t.id()})`;if(t instanceof S)return`(tg.placeholder "${t.name()}")`;if(t instanceof f)return`(tg.template "${t.components().map(n=>typeof n=="string"?n:`\${${Y(n,e)}}`).join("")}")`;if(t instanceof E)return`(tg.resource "${t.id()}")`;if(t instanceof B)return`(tg.target "${t.block.id()}")`;if(t instanceof P)return`(tg.task "${t.id()}")`;{let s="";t.constructor!==void 0&&t.constructor.name!=="Object"&&(s=`${t.constructor.name} `);let n=Object.entries(t).map(([a,o])=>`${a}: ${Y(o,e)}`);return`${s}{ ${n.join(", ")} }`}};var Te=t=>{if(typeof t=="string")return t;{let{arch:e,os:s}=t;return`${e}_${s}`}},re;(n=>(n.is=a=>a==="amd64_linux"||a==="arm64_linux"||a==="amd64_macos"||a==="arm64_macos",n.arch=a=>{switch(a){case"amd64_linux":case"amd64_macos":return"amd64";case"arm64_linux":case"arm64_macos":return"arm64";default:throw new Error("Invalid system.")}},n.os=a=>{switch(a){case"amd64_linux":case"arm64_linux":return"linux";case"amd64_macos":case"arm64_macos":return"macos";default:throw new Error("Invalid system.")}}))(re||={});Object.defineProperties(Error,{prepareStackTrace:{value:xe}});var Ee={log:te};Object.defineProperties(globalThis,{console:{value:Ee}});var Oe={Artifact:y,Blob:h,Block:m,Directory:g,File:x,Placeholder:S,Relpath:d,Subpath:b,Symlink:A,System:re,Target:B,Task:P,Template:f,Value:w,assert:c,blob:H,block:X,directory:we,download:Ae,encoding:W,entrypoint:be,env:D,file:q,include:Se,log:te,output:he,placeholder:J,relpath:U,resolve:k,resource:ge,run:de,subpath:j,symlink:ee,system:Te,target:ke,targets:Q,task:fe,template:F,unimplemented:se,unreachable:p};Object.defineProperties(globalThis,{tg:{value:Oe},t:{value:M}});})();
//# sourceMappingURL=global.js.map
