"use strict";(()=>{var q=e=>Array.from(e);var J=e=>{try{return syscall("log",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},j=()=>{try{return syscall("caller")}catch(e){throw new Error("The syscall failed.",{cause:e})}},Q=async(e,t)=>{try{return await syscall("include",e,t)}catch(r){throw new Error("The syscall failed.",{cause:r})}},X=(e,t)=>{try{return syscall("checksum",e,t)}catch(r){throw new Error("The syscall failed.",{cause:r})}},Y=e=>{try{return syscall("encode_utf8",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},ee=e=>{try{return syscall("decode_utf8",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},te=async e=>{try{return await syscall("add_blob",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},re=async e=>{try{return await syscall("get_blob",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},B=async e=>{try{return await syscall("add_artifact",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},ae=async e=>{try{return await syscall("get_artifact",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}};var se=async e=>{try{return await syscall("add_operation",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}};var ne=async e=>{try{return await syscall("run_operation",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}},ie=async e=>{try{return await syscall("bundle",e)}catch(t){throw new Error("The syscall failed.",{cause:t})}};var v=e=>e instanceof Uint8Array||typeof e=="string"||e instanceof k,M=async e=>{if(e=await e,e instanceof Uint8Array)return new k(await oe(e));if(typeof e=="string"){let t=Y(e);return new k(await oe(t))}else return e},k=class{#e;constructor(t){this.#e=t}hash(){return this.#e}async bytes(){return await Te(this.#e)}async text(){let t=await this.bytes();return ee(t)}},oe=async e=>await te(e),Te=async e=>await re(e);var D=async e=>{if(e=await e,v(e))return new l({blobHash:(await M(e)).hash(),executable:!1,references:[]});if(N(e))return e;{let t=(await M(e.blob)).hash(),r=e.executable??!1,a=await Promise.all((e.references??[]).map(async s=>(s=await s,await s.hash())));return new l({blobHash:t,executable:r,references:a})}},N=e=>e instanceof l,l=class{#e;#t;#r;constructor(t){this.#e=t.blobHash,this.#t=t.executable,this.#r=t.references}async serialize(){let t=this.#e,r=this.#t,a=this.#r;return{blobHash:t,executable:r,references:a}}static async deserialize(t){let r=t.blobHash,a=t.executable,s=t.references;return new l({blobHash:r,executable:a,references:s})}async hash(){return B(await K(this))}blobHash(){return this.#e}blob(){return new k(this.#e)}async bytes(){return await this.blob().bytes()}async text(){return await this.blob().text()}executable(){return this.#t}async references(){return await Promise.all(this.#r.map(d))}};var b=e=>new U(e),le=e=>e instanceof U,U=class{#e;constructor(t){if(typeof t=="string"){this.#e=[];let r=t.split("/");for(let a of r)a===""||a==="."||(a===".."?this.push({kind:"parent_dir"}):this.push({kind:"normal",value:a}))}else t instanceof Array?this.#e=t:this.#e=t.components()}components(){return[...this.#e]}push(t){if(t.kind==="parent_dir"){let r=this.#e.at(-1);r===void 0||r.kind==="parent_dir"?this.#e.push(t):this.#e.pop()}else this.#e.push(t)}parent(){let t=b(this);return t.push({kind:"parent_dir"}),t}join(t){let r=b(this);for(let a of b(t).components())r.push(a);return r}toString(){return this.#e.map(t=>{switch(t.kind){case"parent_dir":return"..";case"normal":return t.value}}).join("/")}};var E=(e,t)=>{if(!e)throw t=t??"Failed assertion.",new Error(t)};var R=e=>new c(e),ce=e=>e instanceof c,c=class{#e;constructor(t){this.#e=t}async serialize(){return{name:this.#e}}static async deserialize(t){let r=t.name;return new c(r)}name(){return this.#e}};var h=async e=>{if(e=await e,e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof o||e instanceof l||e instanceof m||e instanceof c||e instanceof i)return e;if(e instanceof Array)return await Promise.all(e.map(t=>h(t)));if(typeof e=="object")return Object.fromEntries(await Promise.all(Object.entries(e).map(async([t,r])=>[t,await h(r)])));throw new Error("Invalid value to resolve.")};var me=async(e,...t)=>{let r=[];for(let a=0;a<e.length-1;a++){let s=e[a];r.push(s);let n=t[a];r.push(n)}return r.push(e[e.length-1]),await x(r)},x=async e=>{let t=await h(e),r=[],a=s=>{s instanceof Array?s.forEach(a):s instanceof i?r.push(...s.components()):r.push(s)};return a(t),new i(r)},ue=e=>e instanceof i,i=class{#e;constructor(t){this.#e=t}async serialize(){return{components:await Promise.all(this.#e.map(async r=>await He(r)))}}static async deserialize(t){return new i(await Promise.all(t.components.map(async r=>await ze(r))))}components(){return[...this.#e]}render(t){return this.#e.map(t).join("")}},He=async e=>{if(typeof e=="string")return{kind:"string",value:e};if(P(e))return{kind:"artifact",value:await y(e)};if(e instanceof c)return{kind:"placeholder",value:await e.serialize()};throw new Error("Invalid template component.")},ze=async e=>{switch(e.kind){case"string":return await e.value;case"artifact":return await d(e.value);case"placeholder":return await c.deserialize(e.value)}};var pe=async e=>(e=await x(e),new m(e)),ye=e=>e instanceof m,m=class{#e;constructor(t){this.#e=t}async serialize(){return{target:await this.#e.serialize()}}static async deserialize(t){let r=await i.deserialize(t.target);return new m(r)}async hash(){return await y(this)}target(){return this.#e}};var $=e=>e==null;var H=async e=>{if(e==null)return{kind:"null",value:e};if(typeof e=="boolean")return{kind:"bool",value:e};if(typeof e=="number")return{kind:"number",value:e};if(typeof e=="string")return{kind:"string",value:e};if(P(e))return{kind:"artifact",value:await y(e)};if(e instanceof c)return{kind:"placeholder",value:await e.serialize()};if(e instanceof i)return{kind:"template",value:await e.serialize()};if(e instanceof Array)return{kind:"array",value:await Promise.all(e.map(r=>H(r)))};if(typeof e=="object")return{kind:"map",value:Object.fromEntries(await Promise.all(Object.entries(e).map(async([r,a])=>[r,await H(a)])))};throw new Error("Failed to serialize the value.")},g=async e=>{switch(e.kind){case"null":return e.value;case"bool":return e.value;case"number":return e.value;case"string":return e.value;case"artifact":return await d(e.value);case"placeholder":return await c.deserialize(e.value);case"template":return await i.deserialize(e.value);case"array":return await Promise.all(e.value.map(t=>g(t)));case"map":return Object.fromEntries(await Promise.all(Object.entries(e.value).map(async([t,r])=>[t,await g(r)])))}};var L=async(...e)=>{let t=new Map;for(let r of e)if(r=await r,!$(r))if(r instanceof o)for(let[a,s]of r)t.set(a,s);else for(let[a,s]of Object.entries(r)){let[n,...f]=b(a).components();if(n===void 0)throw new Error("The path must have at least one component.");if(n.kind!=="normal")throw new Error("Invalid path component.");let u=n.value;if(f.length>0){let T=b(f).toString(),w=t.get(u),p;w!==void 0&&(p=await d(w),p instanceof o||(p=void 0));let I=await L(p,{[T]:s});t.set(u,await y(I))}else s=await s,$(s)?t.delete(u):v(s)?t.set(u,await y(await D(s))):P(s)?t.set(u,await y(s)):t.set(u,await y(await L(s)))}return new o(t)},S=e=>e instanceof o,o=class{#e;constructor(t){this.#e=t}async serialize(){return{entries:Object.fromEntries(Array.from(this.#e.entries()))}}static async deserialize(t){let r=new Map(Object.entries(t.entries));return new o(r)}hash(){return y(this)}async get(t){let r=await this.tryGet(t);return E(r!==void 0,`Failed to get directory entry "${t}".`),r}async tryGet(t){let r=this;for(let a of b(t).components()){if(E(a.kind==="normal"),!(r instanceof o))return;let s=r.#e.get(a.value);if(!s)return;r=await d(s)}return r}async entries(){let t=new Map;for await(let[r,a]of this)t.set(r,a);return t}*[Symbol.iterator](){for(let[t,r]of this.#e)yield[t,r]}async*[Symbol.asyncIterator](){for(let t of this.#e.keys())yield[t,await this.get(t)]}};var P=e=>e instanceof o||e instanceof l||e instanceof m,y=async e=>await B(await K(e)),d=async e=>await G(await ae(e)),K=async e=>{if(e instanceof o)return{kind:"directory",value:await e.serialize()};if(e instanceof l)return{kind:"file",value:await e.serialize()};if(e instanceof m)return{kind:"symlink",value:await e.serialize()};throw new Error("Unknown artifact type")},G=async e=>{switch(e.kind){case"directory":return await o.deserialize(e.value);case"file":return await l.deserialize(e.value);case"symlink":return await m.deserialize(e.value)}};var fe=async e=>{let t=await h(e),r=await y(t),a=await ie(r),s=await d(a);if(!S(s))throw new Error("vendor syscall returned non-directory artifact.");return s};var he=(e,t)=>X(e,t);var _=new Map;var de=e=>{let{packageInstanceHash:t,line:r}=j(),a;if(r.startsWith("export default "))a="default";else if(r.startsWith("export let ")){let s=r.match(/^export let ([a-zA-Z0-9]+)\b/)?.at(1);if(!s)throw new Error("Invalid use of tg.function.");a=s}else throw new Error("Invalid use of tg.function.");return new z({packageInstanceHash:t,name:a,f:e})};var z=class extends globalThis.Function{packageInstanceHash;name;f;constructor(t){return super(),this.packageInstanceHash=t.packageInstanceHash,this.name=t.name,this.f=t.f,new Proxy(this,{apply:(r,a,s)=>r._call(...s)})}async serialize(){let t=this.packageInstanceHash,r=this.name?.toString();return{packageInstanceHash:t,name:r}}static async deserialize(t){let r=t.packageInstanceHash,a=t.name;return new z({packageInstanceHash:r,name:a})}async _call(...t){let r=new Map(_),a=await Promise.all(t.map(h));return await we({function:this,context:r,args:a})}async run(t,r){for(let[f,u]of Object.entries(t))_.set(f,await g(u));let a=await Promise.all(r.map(g));E(this.f);let s=await this.f(...a);return await H(s)}};var we=async e=>{let t=e.function,r=e.context??new Map,a=e.args??[];return await new V({function:t,context:r,args:a}).run()};var V=class{#e;#t;#r;constructor(t){this.#e=t.function,this.#t=t.context,this.#r=t.args}async serialize(){let t=await this.#e.serialize(),r=Object.fromEntries(await Promise.all(Array.from(this.#t.entries()).map(async([s,n])=>[s,await H(n)]))),a=await Promise.all(this.#r.map(s=>H(s)));return{function:t,context:r,args:a}}static async deserialize(t){let r=await z.deserialize(t.function),a=new Map(await Promise.all(Object.entries(t.context).map(async([n,f])=>[n,await g(f)]))),s=await Promise.all(t.args.map(n=>g(n)));return new V({function:r,context:a,args:s})}async run(){return await F(this)}};var ge=async e=>{let t=await h(e),r=t.system,a=await x(t.command),s=Object.fromEntries(await Promise.all(Object.entries(t.env??{}).map(async([p,I])=>[p,await x(I)]))),n=await Promise.all((t.args??[]).map(async p=>await x(p))),f=t.checksum??null,u=t.unsafe??!1,T=t.network??!1,w=t.hostPaths??[];return await new C({system:r,env:s,command:a,args:n,checksum:f,unsafe:u,network:T,hostPaths:w}).run()},Ae=R("output"),C=class{#e;#t;#r;#a;#s;#n;#i;#o;constructor(t){this.#e=t.system,this.#t=t.command,this.#r=t.env,this.#a=t.args,this.#s=t.checksum,this.#n=t.unsafe,this.#i=t.network,this.#o=t.hostPaths}async serialize(){let t=this.#e,r=await this.#t.serialize(),a=Object.fromEntries(await Promise.all(Object.entries(this.#r).map(async([w,p])=>[w,await p.serialize()]))),s=await Promise.all(this.#a.map(w=>w.serialize())),n=this.#s,f=this.#n,u=this.#i,T=this.#o;return{system:t,command:r,env:a,args:s,checksum:n,unsafe:f,network:u,hostPaths:T}}static async deserialize(t){let r=t.system,a=await i.deserialize(t.command),s=Object.fromEntries(await Promise.all(Object.entries(t.env).map(async([p,I])=>[p,await i.deserialize(I)]))),n=await Promise.all(t.args.map(p=>i.deserialize(p))),f=t.checksum,u=t.unsafe,T=t.network,w=t.hostPaths;return new C({system:r,command:a,env:s,args:n,checksum:f,unsafe:u,network:T,hostPaths:w})}async run(){return await F(this)}};var F=async e=>{let t=await Ve(e),r=await ne(t);return await g(r)},Ve=async e=>await se(await Ce(e));var Ce=async e=>{if(e instanceof O)return{kind:"download",value:await e.serialize()};if(e instanceof C)return{kind:"process",value:await e.serialize()};if(e instanceof V)return{kind:"call",value:await e.serialize()};throw new Error("Cannot serialize operation.")};var ke=async e=>await new O(e).run();var O=class{#e;#t;#r;#a;constructor(t){this.#e=t.url,this.#t=t.unpack??!1,this.#r=t.checksum??null,this.#a=t.unsafe??!1}async serialize(){return{url:this.#e,unpack:this.#t,checksum:this.#r,unsafe:this.#a}}static async deserialize(t){return new O({url:t.url,unpack:t.unpack,checksum:t.checksum,unsafe:t.unsafe})}async run(){return await F(this)}};function be(e,t){return{callSites:t.map(a=>({typeName:a.getTypeName(),functionName:a.getFunctionName(),methodName:a.getMethodName(),fileName:a.getFileName(),lineNumber:a.getLineNumber(),columnNumber:a.getColumnNumber(),isEval:a.isEval(),isNative:a.isNative(),isConstructor:a.isConstructor(),isAsync:a.isAsync(),isPromiseAll:a.isPromiseAll(),promiseIndex:a.getPromiseIndex()}))}}var xe=async e=>{let t=j();return await G(await Q(t,e))};var Z=(...e)=>{let t=e.map(r=>Oe(r)).join(" ");J(t)},Oe=e=>W(e,new Set),W=(e,t)=>{switch(typeof e){case"string":return`"${e}"`;case"number":return e.toString();case"boolean":return e?"true":"false";case"undefined":return"undefined";case"object":return ve(e,t);case"function":return`[function ${e.name??"(anonymous)"}]`;case"symbol":return"[symbol]";case"bigint":return e.toString()}},ve=(e,t)=>{if(e===null)return"null";if(t.has(e))return"[circular]";if(t.add(e),e instanceof Array)return`[${e.map(r=>W(r,t)).join(", ")}]`;if(e instanceof Error)return e.stack??"";if(e instanceof Promise)return"[promise]";{let r="";e.constructor!==void 0&&e.constructor.name!=="Object"&&(r=`${e.constructor.name} `);let a=Object.entries(e).map(([s,n])=>`${s}: ${W(n,t)}`);return`${r}{ ${a.join(", ")} }`}};var Pe=e=>e instanceof Map?e:new Map(Object.entries(e));Object.defineProperties(Error,{prepareStackTrace:{value:be}});var Ue={log:Z};Object.defineProperties(globalThis,{console:{value:Ue}});var Fe={Blob:k,Directory:o,File:l,Path:U,Placeholder:c,Symlink:m,Template:i,array:q,blob:M,bundle:fe,checksum:he,context:_,directory:L,download:ke,file:D,function:de,include:xe,isArtifact:P,isBlobLike:v,isDirectory:S,isFile:N,isPath:le,isPlaceholder:ce,isSymlink:ye,isTemplate:ue,log:Z,map:Pe,output:Ae,path:b,placeholder:R,process:ge,resolve:h,symlink:pe,template:x};Object.defineProperties(globalThis,{t:{value:me},tg:{value:Fe}});})();
//# sourceMappingURL=global.js.map
