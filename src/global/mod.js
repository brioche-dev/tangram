"use strict";(()=>{var F=t=>{let e=[],r=t.length,a=0;for(;a<r;){let n=t.codePointAt(a);if(n===void 0)throw new Error("Invalid code point.");let s=0,i=0;for(n<=127?(s=0,i=0):n<=2047?(s=6,i=192):n<=65535?(s=12,i=224):n<=2097151&&(s=18,i=240),e.push(i|n>>s),s-=6;s>=0;)e.push(128|n>>s&63),s-=6;a+=n>=65536?2:1}return new Uint8Array(e)},I=t=>{for(var e="",r=0;r<t.length;){var a=t[r],n=0,s=0;if(a<=127?(n=0,s=a&255):a<=223?(n=1,s=a&31):a<=239?(n=2,s=a&15):a<=244&&(n=3,s=a&7),t.length-r-n>0)for(var i=0;i<n;)a=t[r+i+1],s=s<<6|a&63,i+=1;else s=65533,n=t.length-r;e+=String.fromCodePoint(s),r+=n+1}return e};var $=t=>typeof t=="string"||t instanceof Uint8Array||t instanceof x,_=async t=>(t=await t,typeof t=="string"?new x(F(t)):t instanceof Uint8Array?new x(t):t),H=class{#e;constructor(e){this.#e=e}toString(){return this.#e}},x=class{bytes;constructor(e){this.bytes=e}toString(){return I(this.bytes)}},K=async t=>new H(await syscall("add_blob",t.bytes)),G=async t=>new x(await syscall("get_blob",t.toString()));var j=async(t,e)=>{let r=await K(await _(t));return new u(r,e)},u=class{blob;executable;constructor(e,r){this.blob=e,this.executable=r?.executable??!1}async serialize(){let e=this.blob.toString(),r=this.executable;return{blob:e,executable:r}}static async deserialize(e){let r=new H(e.blob),a=e.executable;return new u(r,{executable:a})}async getBlob(){return await G(this.blob)}};var g=t=>new S(t),S=class{#e;constructor(e){if(typeof e=="string"){if(this.#e=[],e.length===0)return this;let r=e.split("/");r.at(0)===""&&(this.#e.push({type:"root_dir"}),r.shift());for(let a of r)a===""||(a==="."?this.#e.push({type:"current_dir"}):a===".."?this.#e.push({type:"parent_dir"}):this.#e.push({type:"normal",value:a}))}else Array.isArray(e)?this.#e=e:this.#e=e.components()}components(){return[...this.#e]}parent(){let e=this.components();if(!(e.length===0||e.length===1&&e.at(0)?.type==="root_dir"))return e.pop(),g(e)}join(e){let r=this.components();for(let a of g(e).components())switch(a.type){case"root_dir":{r=[a];break}default:{r.push(a);break}}return g(r)}normalize(){let e=[];for(let r of this.components())switch(r.type){case"root_dir":{e=[r];break}case"current_dir":break;case"parent_dir":{e.length===1&&e.at(0)?.type==="root_dir"||(e.every(a=>a.type==="parent_dir")?e.push(r):e.pop());break}case"normal":{e.push(r);break}}return g(e)}toString(){let e="";for(let r of this.components())switch(r.type){case"root_dir":{e+="/";break}case"current_dir":{e+="./";break}case"parent_dir":{e+="../";break}case"normal":{e+=r.value+"/";break}}return e.length>1&&e.endsWith("/")&&(e=e.slice(0,-1)),e}};var C=async(...t)=>{let e=new Map;for(let r of t)if(r=await r,r!=null)if(r instanceof c)for(let[a,n]of r)e.set(a,n);else for(let[a,n]of Object.entries(r)){let[s,...i]=g(a).normalize().components();if(s.type!=="normal")throw new Error("Invalid path component.");let o=s.value;if(i.length>0){let V=g(i).toString(),R=e.get(o),U;R!==void 0&&(U=await w(R),U instanceof c||(U=void 0));let te=await C(U,{[V]:n});e.set(o,await d(te))}else n=await n,n===null?e.delete(o):$(n)?e.set(o,await d(await j(n))):h(n)?e.set(o,await d(n)):e.set(o,await d(await C(n)))}return new c(e)},c=class{#e;constructor(e){this.#e=e}async serialize(){return{entries:Object.fromEntries(Array.from(this.#e.entries()).map(([r,a])=>[r,a.toString()]))}}static async deserialize(e){let r=new Map(Object.entries(e.entries).map(([a,n])=>{let s=new y(n);return[a,s]}));return new c(r)}async tryGet(e){let[r,...a]=g(e).normalize().components();if(r.type!=="normal")throw new Error(`Invalid path "${e}".`);let n=this.#e.get(r.value);if(!n)return null;let s=await w(n);if(!h(s))throw new Error("Expected an artifact.");if(a.length>0){if(!(s instanceof c))throw new Error("Expected a directory.");return await s.tryGet(a)}else return s}async get(e){let r=await this.tryGet(e);if(r===null)throw new Error(`Failed to get directory entry "${e}".`);return r}async getEntries(){let e={};for await(let[r,a]of this)e[r]=await a;return e}*[Symbol.iterator](){for(let[e,r]of this.#e)yield[e,r]}async*[Symbol.asyncIterator](){for(let e of this.#e.keys())yield[e,await this.get(e)]}};var W=t=>new f(t),f=class{target;constructor(e){this.target=e}async serialize(){return{target:this.target}}static async deserialize(e){return new f(e.target)}};var y=class{#e;constructor(e){this.#e=e}toString(){return this.#e}},h=t=>t instanceof c||t instanceof u||t instanceof f||t instanceof p,d=async t=>new y(await syscall("add_artifact",await re(t))),w=async t=>await ae(await syscall("get_artifact",t.toString())),re=async t=>{if(t instanceof c)return{type:"directory",value:await t.serialize()};if(t instanceof u)return{type:"file",value:await t.serialize()};if(t instanceof f)return{type:"symlink",value:await t.serialize()};if(t instanceof p)return{type:"dependency",value:await t.serialize()};throw new Error("Unknown artifact type")},ae=async t=>{switch(t.type){case"directory":return await c.deserialize(t.value);case"file":return await u.deserialize(t.value);case"symlink":return await f.deserialize(t.value);case"dependency":return await p.deserialize(t.value)}};var Z=async t=>{let e=await d(await t.artifact),r=t.path;return new p({artifact:e,path:r})},p=class{artifact;path;constructor({artifact:e,path:r}){this.artifact=e,this.path=r}static isDependency(e){return e instanceof p}async serialize(){let e=this.artifact.toString(),r=this.path;return{artifact:e,path:r}}static async deserialize(e){return new p({artifact:new y(e.artifact),path:e.path})}async getArtifact(){let e=await w(this.artifact);if(!h(e))throw new Error("The value is not an artifact.");return e}};var B=t=>new m(t),m=class{name;constructor(e){this.name=e}async serialize(){return{name:this.name}}static async deserialize(e){let r=e.name;return new m(r)}};var q=async(t,...e)=>{let r=[];for(let a=0;a<t.length-1;a++){let n=t[a],s=e[a];r.push(n),r.push(s)}return r.push(t[t.length-1]),await E(r)},E=async t=>{let e=await Promise.all(Array.isArray(t)?t:[t]),r=[];for(let a of e)a instanceof l?r.push(...a.components):Array.isArray(a)?r.push(...a):r.push(a);return new l(r)},l=class{components;constructor(e){e instanceof l?this.components=[...e.components]:Array.isArray(e)?this.components=e:this.components=[e]}async serialize(){return{components:await Promise.all(this.components.map(async r=>await ne(r)))}}static async deserialize(e){return new l(await Promise.all(e.components.map(async r=>await se(r))))}},ne=async t=>{if(typeof t=="string")return{type:"string",value:t};if(h(t))return{type:"artifact",value:(await d(t)).toString()};if(t instanceof m)return{type:"placeholder",value:await t.serialize()};throw new Error("Invalid template component.")},se=async t=>{switch(t.type){case"string":return await t.value;case"artifact":return await w(new y(t.value));case"placeholder":return await m.deserialize(t.value)}};var A=async t=>{let e=await t;return e==null||typeof e=="boolean"||typeof e=="number"||typeof e=="string"||e instanceof c||e instanceof u||e instanceof f||e instanceof p||e instanceof m||e instanceof l?e:Array.isArray(e)?await Promise.all(e.map(r=>A(r))):Object.fromEntries(await Promise.all(Object.entries(e).map(async([r,a])=>[r,await A(a)])))};var J=async t=>{let e=await A(t),r=e.system,a=e.env?Object.fromEntries(Object.entries(e.env).map(([o,V])=>[o,new l(V)])):e.env,n=new l(e.command),s=e.args?e.args.map(o=>new l(o)):e.args,i=e.unsafe;return await new P({system:r,env:a,command:n,args:s,unsafe:i}).run()},Q=B("output"),P=class{system;env;command;args;unsafe;constructor(e){this.system=e.system,this.env=e.env,this.command=e.command,this.args=e.args,this.unsafe=e.unsafe}static isProcess(e){return e instanceof P}async serialize(){let e=this.system,r=this.env?Object.fromEntries(await Promise.all(Object.entries(this.env).map(async([i,o])=>[i,await o.serialize()]))):null,a=await this.command.serialize(),n=this.args?await Promise.all(this.args.map(i=>i.serialize())):null,s=this.unsafe;return{system:e,env:r,command:a,args:n,unsafe:s}}static async deserialize(e){let r=e.system,a=e.env?Object.fromEntries(await Promise.all(Object.entries(e.env).map(async([o,V])=>[o,await l.deserialize(V)]))):null,n=await l.deserialize(e.command),s=e.args?await Promise.all(e.args.map(o=>l.deserialize(o))):null,i=e.unsafe;return new P({system:r,env:a,command:n,args:s,unsafe:i})}async run(){return await O(this)}};var X=async()=>await M(new b(syscall("get_current_package_hash")));var b=class{#e;constructor(e){this.#e=e}toString(){return this.#e}},k=class{source;dependencies;constructor({source:e,dependencies:r}){this.source=e,this.dependencies=r}serialize(){let e=this.source.toString(),r=Object.fromEntries(Object.entries(this.dependencies).map(([a,n])=>[a,n.toString()]));return{source:e,dependencies:r}}static deserialize(e){let r=new y(e.source),a=Object.fromEntries(Object.entries(e.dependencies).map(([n,s])=>[n,new b(s)]));return new k({source:r,dependencies:a})}},Y=async t=>new b(await syscall("add_package",t.serialize())),M=async t=>k.deserialize(await syscall("get_package",t.toString()));var D=async t=>{if(t==null)return{type:"null",value:t};if(typeof t=="boolean")return{type:"bool",value:t};if(typeof t=="number")return{type:"number",value:t};if(typeof t=="string")return{type:"string",value:t};if(h(t))return{type:"artifact",value:(await d(t)).toString()};if(t instanceof m)return{type:"placeholder",value:await t.serialize()};if(t instanceof l)return{type:"template",value:await t.serialize()};if(Array.isArray(t))return{type:"array",value:await Promise.all(t.map(r=>D(r)))};if(typeof t=="object")return{type:"map",value:Object.fromEntries(await Promise.all(Object.entries(t).map(async([r,a])=>[r,await D(a)])))};throw new Error("Failed to serialize the value.")},T=async t=>{switch(t.type){case"null":return t.value;case"bool":return t.value;case"number":return t.value;case"string":return t.value;case"artifact":return await w(new y(t.value));case"placeholder":return await m.deserialize(t.value);case"template":return await l.deserialize(t.value);case"array":return await Promise.all(t.value.map(e=>T(e)));case"map":return Object.fromEntries(await Promise.all(Object.entries(t.value).map(async([e,r])=>[e,await T(r)])))}};var L=async t=>await new z(t).run(),z=class{package;name;args;constructor(e){this.package=e.package,this.name=e.name,this.args=e.args}async serialize(){let e=await Y(this.package),r=this.name,a=this.args?await Promise.all(this.args.map(n=>D(n))):null;return{package:e.toString(),name:r,args:a}}static async deserialize(e){let r=await M(new b(e.package)),a=e.name,n=e.args?await Promise.all(e.args.map(s=>T(s))):null;return new z({package:r,name:a,args:n})}async run(){return await O(this)}},N=t=>{let e=new b(syscall("get_current_package_hash")),r=syscall("get_target_name"),a=async n=>{let s=await A(n);return await L({package:await M(e),name:r,args:[s]})};return a.run=async n=>{let s=await T(n),i=await t(s);return await D(i)},a};var O=async t=>{let e=await ie(t),r=await syscall("run",e);return await T(r)},ie=async t=>{if(t instanceof v)return{type:"download",value:await t.serialize()};if(t instanceof P)return{type:"process",value:await t.serialize()};if(t instanceof z)return{type:"target",value:await t.serialize()};throw new Error("Cannot serialize operation.")};var ee=async t=>await new v(t).run(),v=class{url;unpack;checksum;unsafe;constructor(e){this.url=e.url,this.unpack=e.unpack??!1,this.checksum=e.checksum??null,this.unsafe=e.unsafe??!1}async serialize(){return{url:this.url,unpack:this.unpack,checksum:this.checksum,unsafe:this.unsafe}}static async deserialize(e){return new v({url:e.url,unpack:e.unpack,checksum:e.checksum,unsafe:e.unsafe})}async run(){return await O(this)}};var le={Blob:x,blob:_,Dependency:p,dependency:Z,Directory:c,directory:C,download:ee,file:j,File:u,currentPackage:X,Package:k,Path:S,path:g,placeholder:B,Placeholder:m,process:J,output:Q,resolve:A,symlink:W,Symlink:f,target:L,createTarget:N,Template:l,template:E},oe=t=>{let e=(r,a)=>{switch(typeof r){case"string":return`"${r}"`;case"number":return r.toString();case"boolean":return r?"true":"false";case"undefined":return"undefined";case"object":{if(r===null)return"null";if(a.has(r))return"[circular]";if(a.add(r),Array.isArray(r))return`[${r.map(n=>e(n,a)).join(", ")}]`;if(r instanceof Error)return r.stack??"";if(r instanceof Promise)return"[promise]";{let n="";r.constructor!==void 0&&r.constructor.name!=="Object"&&(n=`${r.constructor.name} `);let s=Object.entries(r).map(([i,o])=>`${i}: ${e(o,a)}`);return`${n}{ ${s.join(", ")} }`}}case"function":return`[function ${r.name??"(anonymous)"}]`;case"symbol":return"[symbol]";case"bigint":return r.toString()}};return e(t,new Set)},ce={log:(...t)=>{let e=t.map(r=>oe(r)).join(" ");syscall("print",e)}};Object.defineProperties(globalThis,{console:{value:ce},tg:{value:le},t:{value:q}});})();
